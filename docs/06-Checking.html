<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Typechecking Queries · doobie</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='docs'/>
<link rel="canonical" href="https://github.com/typelevel/doobiedocs/06-Checking.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>doobie
</a>
<div class="version-number">
1.0.0-RC7
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../infographic.html" class="page">Infographic</a></li>
  <li><a href="../migration.html" class="page">Migration Notes</a></li>
  <li><a href="../docs/index.html" class="page">Book of Doobie</a>
  <ul>
    <li><a href="../docs/01-Introduction.html" class="page">Introduction</a></li>
    <li><a href="../docs/02-Toolkit.html" class="page">Toolkit</a></li>
    <li><a href="../docs/03-Connecting.html" class="page">Connecting to a Database</a></li>
    <li><a href="../docs/04-Selecting.html" class="page">Selecting Data</a></li>
    <li><a href="../docs/05-Parameterized.html" class="page">Parameterized Queries</a></li>
    <li><a href="../docs/06-Checking.html" class="active page">Typechecking Queries</a></li>
    <li><a href="../docs/07-Updating.html" class="page">DDL, Inserting, and Updating</a></li>
    <li><a href="../docs/08-Fragments.html" class="page">Statement Fragments</a></li>
    <li><a href="../docs/09-Error-Handling.html" class="page">Error Handling</a></li>
    <li><a href="../docs/10-Logging.html" class="page">Logging</a></li>
    <li><a href="../docs/11-Arrays.html" class="page">SQL Arrays</a></li>
    <li><a href="../docs/12-Custom-Mappings.html" class="page">Custom Mappings</a></li>
    <li><a href="../docs/13-Unit-Testing.html" class="page">Unit Testing</a></li>
    <li><a href="../docs/14-Managing-Connections.html" class="page">Managing Connections</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html" class="page">Extensions for PostgreSQL</a></li>
    <li><a href="../docs/16-Extensions-H2.html" class="page">Extensions for H2</a></li>
    <li><a href="../docs/17-FAQ.html" class="page">Frequently-Asked Questions</a></li>
    <li><a href="../docs/18-Related-Projects.html" class="page">Related Projects</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">doobie</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>doobie
</a>
<div class="version-number">
1.0.0-RC7
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../infographic.html" class="page">Infographic</a></li>
  <li><a href="../migration.html" class="page">Migration Notes</a></li>
  <li><a href="../docs/index.html" class="page">Book of Doobie</a>
  <ul>
    <li><a href="../docs/01-Introduction.html" class="page">Introduction</a></li>
    <li><a href="../docs/02-Toolkit.html" class="page">Toolkit</a></li>
    <li><a href="../docs/03-Connecting.html" class="page">Connecting to a Database</a></li>
    <li><a href="../docs/04-Selecting.html" class="page">Selecting Data</a></li>
    <li><a href="../docs/05-Parameterized.html" class="page">Parameterized Queries</a></li>
    <li><a href="../docs/06-Checking.html" class="active page">Typechecking Queries</a></li>
    <li><a href="../docs/07-Updating.html" class="page">DDL, Inserting, and Updating</a></li>
    <li><a href="../docs/08-Fragments.html" class="page">Statement Fragments</a></li>
    <li><a href="../docs/09-Error-Handling.html" class="page">Error Handling</a></li>
    <li><a href="../docs/10-Logging.html" class="page">Logging</a></li>
    <li><a href="../docs/11-Arrays.html" class="page">SQL Arrays</a></li>
    <li><a href="../docs/12-Custom-Mappings.html" class="page">Custom Mappings</a></li>
    <li><a href="../docs/13-Unit-Testing.html" class="page">Unit Testing</a></li>
    <li><a href="../docs/14-Managing-Connections.html" class="page">Managing Connections</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html" class="page">Extensions for PostgreSQL</a></li>
    <li><a href="../docs/16-Extensions-H2.html" class="page">Extensions for H2</a></li>
    <li><a href="../docs/17-FAQ.html" class="page">Frequently-Asked Questions</a></li>
    <li><a href="../docs/18-Related-Projects.html" class="page">Related Projects</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">doobie</a></li>
  <li><a href="../docs/index.html">Book of Doobie</a></li>
  <li>Typechecking Queries</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h2><a href="#typechecking-queries" name="typechecking-queries" class="anchor"><span class="anchor-link"></span></a>Typechecking Queries</h2>
<p>In this chapter we learn how to use YOLO mode to validate queries against the database schema and ensure that our type mappings are correct (and if not, get some hints on how to fix them).</p>
<h3><a href="#setting-up" name="setting-up" class="anchor"><span class="anchor-link"></span></a>Setting Up</h3>
<p>Our setup here is the same as last chapter, so if you&rsquo;re still running from last chapter you can skip this section. Otherwise: imports, <code>Transactor</code>, and YOLO mode.</p>
<pre class="prettyprint"><code class="language-scala">import doobie._
import doobie.implicits._
import doobie.util.ExecutionContexts
import cats._
import cats.data._
import cats.effect._
import cats.implicits._

// This is just for testing. Consider using cats.effect.IOApp instead of calling
// unsafe methods directly.
import cats.effect.unsafe.implicits.global

// A transactor that gets connections from java.sql.DriverManager and executes blocking operations
// on an our synchronous EC. See the chapter on connection handling for more info.
val xa = Transactor.fromDriverManager[IO](
  driver = &quot;org.postgresql.Driver&quot;,  // JDBC driver classname
  url = &quot;jdbc:postgresql:world&quot;,     // Connect URL - Driver specific
  user = &quot;postgres&quot;,                 // Database user name
  password = &quot;password&quot;,             // Database password
  logHandler = None                  // Don&#39;t setup logging for now. See Logging page for how to log events in detail
)

val y = xa.yolo
import y._
</code></pre>
<p>And again, we&rsquo;re playing with the <code>country</code> table, shown here for reference.</p>
<pre class="prettyprint"><code class="language-sql">CREATE TABLE country (
  code        character(3)  NOT NULL,
  name        text          NOT NULL,
  population  integer NOT NULL,
  gnp         numeric(10,2),
  indepyear   smallint
  -- more columns, but we won&#39;t use them here
)
</code></pre>
<h3><a href="#checking-a-query" name="checking-a-query" class="anchor"><span class="anchor-link"></span></a>Checking a Query</h3>
<p>In order to create a query that&rsquo;s not quite right, let&rsquo;s redefine our <code>Country</code> class with slightly different types.</p>
<pre class="prettyprint"><code class="language-scala">case class Country(code: Int, name: String, pop: Int, gnp: Double)
</code></pre>
<p>Here&rsquo;s our parameterized query from last chapter, but with the new <code>Country</code> definition and the <code>minPop</code> parameter changed to a <code>Short</code>.</p>
<pre class="prettyprint"><code class="language-scala">def biggerThan(minPop: Short) =
  sql&quot;&quot;&quot;
    select code, name, population, gnp, indepyear
    from country
    where population &gt; $minPop
  &quot;&quot;&quot;.query[Country]
</code></pre>
<p>Now let&rsquo;s try the <code>check</code> method provided by YOLO and see what happens.</p>
<pre class="prettyprint"><code class="language-scala">biggerThan(0).check.unsafeRunSync()
</code></pre>
<p>Yikes, there are quite a few problems, in several categories. In this case <strong>doobie</strong> found</p>
<ul>
  <li>a parameter coercion that should always work but is not required to be supported by compliant drivers;</li>
  <li>two column coercions that <strong>are</strong> supported by JDBC but are not recommended and can fail in some cases;</li>
  <li>a column nullability mismatch, where a column that is <em>provably</em> nullable is read into a non-<code>Option</code> type;</li>
  <li>and an unused column.</li>
</ul>
<p>If we fix all of these problems and try again, we get a clean bill of health.</p>
<pre class="prettyprint"><code class="language-scala">case class Country2(code: String, name: String, pop: Int, gnp: Option[BigDecimal])

def biggerThan2(minPop: Int) =
  sql&quot;&quot;&quot;
    select code, name, population, gnp
    from country
    where population &gt; $minPop
  &quot;&quot;&quot;.query[Country2]
</code></pre>
<pre class="prettyprint"><code class="language-scala">biggerThan2(0).check.unsafeRunSync()
</code></pre>
<p><strong>doobie</strong> supports <code>check</code> for queries and updates in four ways: programmatically, via YOLO mode in the REPL, and via the <code>doobie-specs2</code>, <code>doobie-scalatest</code> and <code>doobie-munit</code> packages, which allow checking to become part of your unit test suite. We will investigate this in the chapter on testing.</p>
<h3><a href="#working-around-bad-metadata" name="working-around-bad-metadata" class="anchor"><span class="anchor-link"></span></a>Working Around Bad Metadata</h3>
<p>Some drivers do not implement the JDBC metadata specification very well, which limits the usefulness of the query checking feature. MySQL and MS-SQL do a particularly rotten job in this department. In some cases queries simply cannot be checked because no metadata is available for the prepared statement (manifested as an exception) or the returned metadata is obviously inaccurate.</p>
<p>However a common case is that <em>parameter</em> metadata is unavailable but <em>output column</em> metadata is. And in these cases there is a workaround: use <code>checkOutput</code> rather than <code>check</code>. This instructs <strong>doobie</strong> to punt on the input parameters and only check output columns. Unsatisfying but better than nothing.</p>
<pre class="prettyprint"><code class="language-scala">biggerThan(0).checkOutput.unsafeRunSync()
</code></pre>
<h3><a href="#diving-deeper" name="diving-deeper" class="anchor"><span class="anchor-link"></span></a>Diving Deeper</h3>
<p>The <code>check</code> logic requires both a database connection and concrete <code>Get</code> and <code>Put</code> instances that define column-level JDBC mappings.</p>
<p>The way this works is that a <code>Query</code> value has enough type information to describe all parameter and column mappings, as well as the SQL literal itself (with interpolated parameters erased into <code>?</code>). From here it is straightforward to prepare the statement, pull the <code>ResultsetMetaData</code> and <code>DatabaseMetaData</code> and work out whether things are aligned correctly (and if not, determine how misalignments might be fixed). The <code>Anaylsis</code> class consumes this metadata and is able to provide the following diagnostics:</p>
<ul>
  <li>SQL validity. The query must compile, which means it must be consistent with the schema.</li>
  <li>Parameter and column arity. All query inputs and outputs must map 1:1 with parameters and columns.</li>
  <li>Nullability. A parameter or column that is <em>provably</em> nullable must be mapped to a Scala <code>Option</code>. Note that this is a weak guarantee; columns introduced by an outer join might be nullable but JDBC will tend to report them as &ldquo;might not be nullable&rdquo; which isn&rsquo;t useful information.</li>
  <li>Coercibility of types. Mapping of Scala types to JDBC types and JDBC types to vendor types, is asymmetric with respect to reading and writing, and the specification is quite terrible. <strong>doobie</strong> encodes the JDBC spec and combines this with vendor-specific metadata to determine whether a given asserted mapping is sensible or not, and if not, will suggest a fix via changing the Scala type, and another via changing the schema type.</li>
</ul>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/typelevel/doobie/tree/master/modules/docs/target/mdoc/docs/06-Checking.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../docs/07-Updating.html">DDL, Inserting, and Updating</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../docs/06-Checking.html#typechecking-queries" class="header">Typechecking Queries</a>
  <ul>
    <li><a href="../docs/06-Checking.html#setting-up" class="header">Setting Up</a></li>
    <li><a href="../docs/06-Checking.html#checking-a-query" class="header">Checking a Query</a></li>
    <li><a href="../docs/06-Checking.html#working-around-bad-metadata" class="header">Working Around Bad Metadata</a></li>
    <li><a href="../docs/06-Checking.html#diving-deeper" class="header">Diving Deeper</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2025</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.0.0-RC7', 'https://github.com/typelevel/doobie')});</script>


</html>
