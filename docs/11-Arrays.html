<html><head><title>doobie: SQL Arrays</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Rob Norris" /><meta name="description" content="A functional JDBC layer for Scala." /><meta name="og:image" content="/doobie/img/poster.png" /><meta name="image" property="og:image" content="/doobie/img/poster.png" /><meta name="og:title" content="doobie: SQL Arrays" /><meta name="title" property="og:title" content="doobie: SQL Arrays" /><meta name="og:site_name" content="doobie" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="A functional JDBC layer for Scala." /><link rel="icon" type="image/png" href="/doobie/img/favicon.png" /><meta name="twitter:title" content="doobie: SQL Arrays" /><meta name="twitter:image" content="/doobie/img/poster.png" /><meta name="twitter:description" content="A functional JDBC layer for Scala." /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/doobie/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/doobie/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/doobie/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/doobie/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/doobie/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/doobie/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/doobie/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/doobie/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/doobie/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/doobie/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/doobie/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/doobie/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/doobie/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/doobie/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/doobie/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/doobie/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/doobie/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/doobie/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/doobie/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/doobie/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/doobie/highlight/styles/color-brewer.css" /><link rel="stylesheet" href="/doobie/css/style.css" /><link rel="stylesheet" href="/doobie/css/palette.css" /><link rel="stylesheet" href="/doobie/css/codemirror.css" /><link rel="stylesheet" href="/doobie/css/tweak.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/doobie/" class="brand"><div class="brand-wrapper"><span>doobie</span></div></a></li><li><a href="/doobie/docs/01-Introduction.html" class="">Introduction</a></li><li><a href="/doobie/docs/02-Toolkit.html" class="">Toolkit</a></li><li><a href="/doobie/docs/03-Connecting.html" class="">Connecting to a Database</a></li><li><a href="/doobie/docs/04-Selecting.html" class="">Selecting Data</a></li><li><a href="/doobie/docs/05-Parameterized.html" class="">Parameterized Queries</a></li><li><a href="/doobie/docs/06-Checking.html" class="">Typechecking Queries</a></li><li><a href="/doobie/docs/07-Updating.html" class="">DDL, Inserting, and Updating</a></li><li><a href="/doobie/docs/08-Fragments.html" class="">Statement Fragments</a></li><li><a href="/doobie/docs/09-Error-Handling.html" class="">Error Handling</a></li><li><a href="/doobie/docs/10-Logging.html" class="">Logging</a></li><li><a href="/doobie/docs/11-Arrays.html" class=" active ">SQL Arrays</a></li><li><a href="/doobie/docs/12-Custom-Mappings.html" class="">Custom Mappings</a></li><li><a href="/doobie/docs/13-Unit-Testing.html" class="">Unit Testing</a></li><li><a href="/doobie/docs/14-Managing-Connections.html" class="">Managing Connections</a></li><li><a href="/doobie/docs/15-Extensions-PostgreSQL.html" class="">Extensions for PostgreSQL</a></li><li><a href="/doobie/docs/16-Extensions-H2.html" class="">Extensions for H2</a></li><li><a href="/doobie/docs/17-Quill.html" class="">Quill Integration</a></li><li><a href="/doobie/docs/18-FAQ.html" class="">Frequently-Asked Questions</a></li><li><a href="/doobie/" class=""></a></li><li><a href="/doobie/css/palette.css" class=""></a></li><li><a href="/doobie/css/style.css" class=""></a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/tpolecat/doobie"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/tpolecat/doobie"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('doobie A functional JDBC layer for Scala.');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('doobie A functional JDBC layer for Scala.');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="tpolecat" data-github-repo="doobie"><div class="content-wrapper"><section><h2 id="sql-arrays">SQL Arrays</h2>

<p>This chapter shows how we can map Scala sequence types to SQL <code class="highlighter-rouge">ARRAY</code> types, for vendors that support it. Note that although SQL array mappings are part of the JDBC specification,  their behavior is vendor-specific and requires an add-on library; the code in this chapter requires <code class="highlighter-rouge">doobie-postgres</code>.</p>

<h3 id="setting-up">Setting Up</h3>

<p>Again we set up a transactor and pull in YOLO mode. We also need an import to get PostgreSQL-specific type mappings.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie._</span>
<span class="k">import</span> <span class="nn">doobie.implicits._</span>
<span class="k">import</span> <span class="nn">doobie.postgres._</span>
<span class="k">import</span> <span class="nn">doobie.postgres.implicits._</span>
<span class="k">import</span> <span class="nn">doobie.util.ExecutionContexts</span>
<span class="k">import</span> <span class="nn">cats._</span>
<span class="k">import</span> <span class="nn">cats.data._</span>
<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>

<span class="c1">// We need a ContextShift[IO] before we can construct a Transactor[IO]. The passed ExecutionContext
// is where nonblocking operations will be executed. For testing here we're using a synchronous EC.
</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">cs</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">.</span><span class="n">contextShift</span><span class="o">(</span><span class="nc">ExecutionContexts</span><span class="o">.</span><span class="n">synchronous</span><span class="o">)</span>

<span class="c1">// A transactor that gets connections from java.sql.DriverManager and executes blocking operations
// on an our synchronous EC. See the chapter on connection handling for more info.
</span><span class="k">val</span> <span class="n">xa</span> <span class="k">=</span> <span class="nc">Transactor</span><span class="o">.</span><span class="n">fromDriverManager</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span>
  <span class="s">"org.postgresql.Driver"</span><span class="o">,</span>     <span class="c1">// driver classname
</span>  <span class="s">"jdbc:postgresql:world"</span><span class="o">,</span>     <span class="c1">// connect URL (driver-specific)
</span>  <span class="s">"postgres"</span><span class="o">,</span>                  <span class="c1">// user
</span>  <span class="s">""</span><span class="o">,</span>                          <span class="c1">// password
</span>  <span class="nc">ExecutionContexts</span><span class="o">.</span><span class="n">synchronous</span> <span class="c1">// just for testing
</span><span class="o">)</span>

<span class="k">val</span> <span class="n">y</span> <span class="k">=</span> <span class="n">xa</span><span class="o">.</span><span class="n">yolo</span>
<span class="k">import</span> <span class="nn">y._</span>
</code></pre>
</div>

<h3 id="reading-and-writing-arrays">Reading and Writing Arrays</h3>

<p>Let’s create a new table with an SQL array column. Note that this is likely to work only for PostgreSQL; the syntax for arrays differs significantly from vendor to vendor.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">drop</span> <span class="k">=</span> <span class="n">sql</span><span class="s">"DROP TABLE IF EXISTS person"</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">quick</span>

<span class="k">val</span> <span class="n">create</span> <span class="k">=</span>
  <span class="n">sql</span><span class="s">"""
    CREATE TABLE person (
      id   SERIAL,
      name VARCHAR   NOT NULL UNIQUE,
      pets VARCHAR[] NOT NULL
    )
  """</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">quick</span>
</code></pre>
</div>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="o">(</span><span class="n">drop</span> <span class="o">*&gt;</span> <span class="n">create</span><span class="o">).</span><span class="n">unsafeRunSync</span>
<span class="c1">//   0 row(s) updated
//   0 row(s) updated
</span></code></pre>
</div>

<p><strong>doobie</strong> maps SQL array columns to <code class="highlighter-rouge">Array</code>, <code class="highlighter-rouge">List</code>, and <code class="highlighter-rouge">Vector</code> by default. No special handling is required, other than importing the vendor-specific array support above.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">pets</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>

<span class="k">def</span> <span class="n">insert</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">pets</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">ConnectionIO</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">sql</span><span class="s">"insert into person (name, pets) values ($name, $pets)"</span>
    <span class="o">.</span><span class="n">update</span>
    <span class="o">.</span><span class="n">withUniqueGeneratedKeys</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="s">"name"</span><span class="o">,</span> <span class="s">"pets"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Insert works fine, as does reading the result. No surprises.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">insert</span><span class="o">(</span><span class="s">"Bob"</span><span class="o">,</span> <span class="nc">List</span><span class="o">(</span><span class="s">"Nixon"</span><span class="o">,</span> <span class="s">"Slappy"</span><span class="o">)).</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="c1">//   Person(1,Bob,List(Nixon, Slappy))
</span><span class="n">insert</span><span class="o">(</span><span class="s">"Alice"</span><span class="o">,</span> <span class="nc">Nil</span><span class="o">).</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="c1">//   Person(2,Alice,List())
</span></code></pre>
</div>

<h3 id="lamentations-of-null">Lamentations of <code class="highlighter-rouge">NULL</code></h3>

<p><strong>doobie</strong> maps nullable columns via <code class="highlighter-rouge">Option</code>, so <code class="highlighter-rouge">null</code> is never observed in programs that use the high-level API, and the typechecking feature discussed earlier will find mismatches. So this means if you have a nullable SQL <code class="highlighter-rouge">varchar[]</code> then you will be chided grimly if you don’t map it as <code class="highlighter-rouge">Option[List[String]]</code> (or some other supported sequence type).</p>

<p>However there is another axis of variation here: the <em>array cells</em> themselves may contain null values. And the query checker can’t save you here because this is not reflected in the metadata provided by PostgreSQL or H2, and probably not by anyone.</p>

<p>So there are actually four ways to map an array, and you should carefully consider which is appropriate for your schema. In the first two cases reading a <code class="highlighter-rouge">NULL</code> cell would result in a <code class="highlighter-rouge">NullableCellRead</code> exception.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">sql</span><span class="s">"select array['foo','bar','baz']"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]].</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="c1">//   List(foo, bar, baz)
</span><span class="n">sql</span><span class="s">"select array['foo','bar','baz']"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]]].</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="c1">//   Some(List(foo, bar, baz))
</span><span class="n">sql</span><span class="s">"select array['foo',NULL,'baz']"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]]].</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="c1">//   List(Some(foo), None, Some(baz))
</span><span class="n">sql</span><span class="s">"select array['foo',NULL,'baz']"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]]]].</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
<span class="c1">//   Some(List(Some(foo), None, Some(baz)))
</span></code></pre>
</div>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/doobie/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script src="/doobie/js/main.js"></script></body></html>