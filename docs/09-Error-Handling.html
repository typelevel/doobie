<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Error Handling · doobie</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='docs'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>doobie
</a>
<div class="version-number">
0.9.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../infographic.html" class="page">Infographic</a></li>
  <li><a href="../migration.html" class="page">Migration Notes</a></li>
  <li><a href="../docs/index.html" class="page">Book of Doobie</a>
  <ul>
    <li><a href="../docs/01-Introduction.html" class="page">Introduction</a></li>
    <li><a href="../docs/02-Toolkit.html" class="page">Toolkit</a></li>
    <li><a href="../docs/03-Connecting.html" class="page">Connecting to a Database</a></li>
    <li><a href="../docs/04-Selecting.html" class="page">Selecting Data</a></li>
    <li><a href="../docs/05-Parameterized.html" class="page">Parameterized Queries</a></li>
    <li><a href="../docs/06-Checking.html" class="page">Typechecking Queries</a></li>
    <li><a href="../docs/07-Updating.html" class="page">DDL, Inserting, and Updating</a></li>
    <li><a href="../docs/08-Fragments.html" class="page">Statement Fragments</a></li>
    <li><a href="../docs/09-Error-Handling.html" class="active page">Error Handling</a></li>
    <li><a href="../docs/10-Logging.html" class="page">Logging</a></li>
    <li><a href="../docs/11-Arrays.html" class="page">SQL Arrays</a></li>
    <li><a href="../docs/12-Custom-Mappings.html" class="page">Custom Mappings</a></li>
    <li><a href="../docs/13-Unit-Testing.html" class="page">Unit Testing</a></li>
    <li><a href="../docs/14-Managing-Connections.html" class="page">Managing Connections</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html" class="page">Extensions for PostgreSQL</a></li>
    <li><a href="../docs/16-Extensions-H2.html" class="page">Extensions for H2</a></li>
    <li><a href="../docs/17-Quill.html" class="page">Quill Integration</a></li>
    <li><a href="../docs/18-FAQ.html" class="page">Frequently-Asked Questions</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">doobie</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>doobie
</a>
<div class="version-number">
0.9.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../infographic.html" class="page">Infographic</a></li>
  <li><a href="../migration.html" class="page">Migration Notes</a></li>
  <li><a href="../docs/index.html" class="page">Book of Doobie</a>
  <ul>
    <li><a href="../docs/01-Introduction.html" class="page">Introduction</a></li>
    <li><a href="../docs/02-Toolkit.html" class="page">Toolkit</a></li>
    <li><a href="../docs/03-Connecting.html" class="page">Connecting to a Database</a></li>
    <li><a href="../docs/04-Selecting.html" class="page">Selecting Data</a></li>
    <li><a href="../docs/05-Parameterized.html" class="page">Parameterized Queries</a></li>
    <li><a href="../docs/06-Checking.html" class="page">Typechecking Queries</a></li>
    <li><a href="../docs/07-Updating.html" class="page">DDL, Inserting, and Updating</a></li>
    <li><a href="../docs/08-Fragments.html" class="page">Statement Fragments</a></li>
    <li><a href="../docs/09-Error-Handling.html" class="active page">Error Handling</a></li>
    <li><a href="../docs/10-Logging.html" class="page">Logging</a></li>
    <li><a href="../docs/11-Arrays.html" class="page">SQL Arrays</a></li>
    <li><a href="../docs/12-Custom-Mappings.html" class="page">Custom Mappings</a></li>
    <li><a href="../docs/13-Unit-Testing.html" class="page">Unit Testing</a></li>
    <li><a href="../docs/14-Managing-Connections.html" class="page">Managing Connections</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html" class="page">Extensions for PostgreSQL</a></li>
    <li><a href="../docs/16-Extensions-H2.html" class="page">Extensions for H2</a></li>
    <li><a href="../docs/17-Quill.html" class="page">Quill Integration</a></li>
    <li><a href="../docs/18-FAQ.html" class="page">Frequently-Asked Questions</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">doobie</a></li>
  <li><a href="../docs/index.html">Book of Doobie</a></li>
  <li>Error Handling</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h2><a href="#error-handling" name="error-handling" class="anchor"><span class="anchor-link"></span></a>Error Handling</h2>
<p>In this chapter we examine a set of combinators that allow us to construct programs that trap and handle exceptions.</p>
<h3><a href="#setting-up" name="setting-up" class="anchor"><span class="anchor-link"></span></a>Setting Up</h3>
<pre class="prettyprint"><code class="language-scala">import doobie._
import doobie.implicits._
import doobie.util.ExecutionContexts
import cats._
import cats.data._
import cats.effect._
import cats.implicits._

// We need a ContextShift[IO] before we can construct a Transactor[IO]. The passed ExecutionContext
// is where nonblocking operations will be executed. For testing here we&#39;re using a synchronous EC.
implicit val cs = IO.contextShift(ExecutionContexts.synchronous)

// A transactor that gets connections from java.sql.DriverManager and executes blocking operations
// on an our synchronous EC. See the chapter on connection handling for more info.
val xa = Transactor.fromDriverManager[IO](
  &quot;org.postgresql.Driver&quot;,     // driver classname
  &quot;jdbc:postgresql:world&quot;,     // connect URL (driver-specific)
  &quot;postgres&quot;,                  // user
  &quot;&quot;,                          // password
  Blocker.liftExecutionContext(ExecutionContexts.synchronous) // just for testing
)

val y = xa.yolo
import y._
</code></pre>
<h3><a href="#about-exceptions" name="about-exceptions" class="anchor"><span class="anchor-link"></span></a>About Exceptions</h3>
<p>Exceptions are a fact of life when interacting with databases, and they are largely nondeterministic; whether an operation will succeed or not depends on unpredictable factors like network health, the current contents of tables, locking state, and so on. So we must decide whether to compute everything in a disjunction like <code>EitherT[ConnectionIO, Throwable, A]</code> or allow exceptions to propagate until they are caught explicitly. <strong>doobie</strong> adopts the second strategy: exceptions are allowed to propagate and escape unless handled explicitly (exactly as <code>IO</code> works). This means when a <strong>doobie</strong> action (transformed to some target monad) is executed, exceptions can escape.</p>
<p>There are three main types of exceptions that are likely to arise:</p>
<ol>
  <li>Various types of <code>IOException</code> can happen with any kind of I/O, and these exceptions tend to be unrecoverable.</li>
  <li>Database exceptions, typically as a generic <code>SQLException</code> with a vendor-specific <code>SQLState</code> identifying the specific error, are raised for common situations such as key violations. Some vendors (PostgreSQL for instance) publish a table of error codes, and in these cases <strong>doobie</strong> can provide a matching set of exception-handling combinators. However in most cases the error codes must be passed down as folklore or discovered by experimentation. There exist the XOPEN and SQL:2003 standards, but it seems that no vendor adheres closely to these specifications. Some of these errors are recoverable and others aren&rsquo;t.</li>
  <li><strong>doobie</strong> will raise an <code>InvariantViolation</code> in response to invalid type mappings, unknown JDBC constants returned by drivers, observed <code>NULL</code> values, and other violations of invariants that <strong>doobie</strong> assumes. These exceptions indicate programmer error or driver non-compliance and are generally unrecoverable.</li>
</ol>
<h3><a href="#monaderror-and-derived-combinators" name="monaderror-and-derived-combinators" class="anchor"><span class="anchor-link"></span></a><code>MonadError</code> and Derived Combinators</h3>
<p>All <strong>doobie</strong> monads provide an <code>Async</code> instance, which extends <code>MonadError[?[_], Throwable]</code>. This means <code>ConnectionIO</code>, etc., have the following primitive operations:</p>
<ul>
  <li><code>.attempt</code> converts <code>M[A]</code> into <code>M[Either[Throwable, A]]</code></li>
  <li><code>fail</code> constructs an <code>M[A]</code> that fails with a provided <code>Throwable</code></li>
</ul>
<p>So any <strong>doobie</strong> program can be lifted into a disjunction simply by adding <code>.attempt</code>.</p>
<pre class="prettyprint"><code class="language-scala">val p = 42.pure[ConnectionIO]
// p: ConnectionIO[Int] = Pure(42)
p.attempt
// res0: ConnectionIO[Either[Throwable, Int]] = Suspend(
//   HandleErrorWith(
//     FlatMapped(Pure(42), cats.Monad$$Lambda$10635/1801863636@443f823f),
//     cats.ApplicativeError$$Lambda$10732/1783129345@755e11b2
//   )
// )
</code></pre>
<p>From the <code>.attempt</code> and <code>fail</code> combinators we can derive many other operations, as described in the Cats documentation. In addition <strong>doobie</strong> provides the following specialized combinators that only pay attention to <code>SQLException</code>:</p>
<ul>
  <li><code>attemptSql</code> is like <code>attempt</code> but only traps <code>SQLException</code>.</li>
  <li><code>attemptSomeSql</code> traps only specified <code>SQLException</code>s.</li>
  <li><code>exceptSql</code> recovers from an <code>SQLException</code> with a new action.</li>
  <li><code>onSqlException</code> executes an action on <code>SQLException</code> and discards its result.</li>
</ul>
<p>And finally we have a set of combinators that focus on <code>SQLState</code>s.</p>
<ul>
  <li><code>attemptSqlState</code> is like <code>attemptSql</code> but yields <code>M[Either[SQLState, A]]</code>.</li>
  <li><code>attemptSomeSqlState</code> traps only specified <code>SQLState</code>s.</li>
  <li><code>exceptSqlState</code> recovers from an <code>SQLState</code> with a new action.</li>
  <li><code>exceptSomeSqlState</code> recovers from specified <code>SQLState</code>s with a new action.</li>
</ul>
<p>See the ScalaDoc for more information.</p>
<h3><a href="#example-unique-constraint-violation" name="example-unique-constraint-violation" class="anchor"><span class="anchor-link"></span></a>Example: Unique Constraint Violation</h3>
<p>Ok let&rsquo;s set up a <code>person</code> table again, using a slightly different formulation just for fun. Note that the <code>name</code> column is marked as being unique.</p>
<pre class="prettyprint"><code class="language-scala">List(
  sql&quot;&quot;&quot;DROP TABLE IF EXISTS person&quot;&quot;&quot;,
  sql&quot;&quot;&quot;CREATE TABLE person (
          id    SERIAL,
          name  VARCHAR NOT NULL UNIQUE
        )&quot;&quot;&quot;
).traverse(_.update.quick).void.unsafeRunSync
//   0 row(s) updated
//   0 row(s) updated
</code></pre>
<p>Alright, let&rsquo;s define a <code>Person</code> data type and a way to insert instances.</p>
<pre class="prettyprint"><code class="language-scala">case class Person(id: Int, name: String)

def insert(s: String): ConnectionIO[Person] = {
  sql&quot;insert into person (name) values ($s)&quot;
    .update
    .withUniqueGeneratedKeys(&quot;id&quot;, &quot;name&quot;)
}
</code></pre>
<p>The first insert will work.</p>
<pre class="prettyprint"><code class="language-scala">insert(&quot;bob&quot;).quick.unsafeRunSync
//   Person(1,bob)
</code></pre>
<p>The second will fail with a unique constraint violation.</p>
<pre class="prettyprint"><code class="language-scala">try {
  insert(&quot;bob&quot;).quick.unsafeRunSync
} catch {
  case e: java.sql.SQLException =&gt;
    println(e.getMessage)
    println(e.getSQLState)
}
// ERROR: duplicate key value violates unique constraint &quot;person_name_key&quot;
//   Detail: Key (name)=(bob) already exists.
// 23505
</code></pre>
<p>So let&rsquo;s change our method to return an <code>Either[String, Person]</code> by using the <code>attemptSomeSql</code> combinator. This allows us to specify the <code>SQLState</code> value that we want to trap. In this case the culprit <code>&quot;23505&quot;</code> (yes, it&rsquo;s a string) is provided as a constant in the <code>doobie-postgres</code> add-on.</p>
<pre class="prettyprint"><code class="language-scala">import doobie.postgres._

def safeInsert(s: String): ConnectionIO[Either[String, Person]] =
  insert(s).attemptSomeSqlState {
    case sqlstate.class23.UNIQUE_VIOLATION =&gt; &quot;Oops!&quot;
  }
</code></pre>
<p>Given this definition we can safely attempt to insert duplicate records and get a helpful error message rather than an exception.</p>
<pre class="prettyprint"><code class="language-scala">safeInsert(&quot;bob&quot;).quick.unsafeRunSync
//   Left(Oops!)

safeInsert(&quot;steve&quot;).quick.unsafeRunSync
//   Right(Person(4,steve))
</code></pre>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tpolecat/doobie/tree/master/modules/docs/target/mdoc/docs/09-Error-Handling.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../docs/10-Logging.html">Logging</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../docs/09-Error-Handling.html#error-handling" class="header">Error Handling</a>
  <ul>
    <li><a href="../docs/09-Error-Handling.html#setting-up" class="header">Setting Up</a></li>
    <li><a href="../docs/09-Error-Handling.html#about-exceptions" class="header">About Exceptions</a></li>
    <li><a href="../docs/09-Error-Handling.html#monaderror-and-derived-combinators" class="header"><code>MonadError</code> and Derived Combinators</a></li>
    <li><a href="../docs/09-Error-Handling.html#example-unique-constraint-violation" class="header">Example: Unique Constraint Violation</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2020</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.9.0', '')});</script>


</html>
