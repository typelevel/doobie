<html><head><title>doobie</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Rob Norris" /><meta name="description" content="A principled JDBC layer for Scala." /><meta name="og:image" content="/doobie/img/poster.png" /><meta name="og:title" content="doobie" /><meta name="og:site_name" content="doobie" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="A principled JDBC layer for Scala." /><link rel="icon" type="image/png" href="/doobie/img/favicon.png" /><meta name="twitter:title" content="doobie" /><meta name="twitter:image" content="img/poster.png" /><meta name="twitter:description" content="A principled JDBC layer for Scala." /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/doobie/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/doobie/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/doobie/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/doobie/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/doobie/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/doobie/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/doobie/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/doobie/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/doobie/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/doobie/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/doobie/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/doobie/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/doobie/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/doobie/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/doobie/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/doobie/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/doobie/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/doobie/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/doobie/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/doobie/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/doobie/highlight/styles/color-brewer.css" /><link rel="stylesheet" href="/doobie/css/style.css" /><link rel="stylesheet" href="/doobie/css/palette.css" /><link rel="stylesheet" href="/doobie/css/codemirror.css" /><link rel="stylesheet" href="/doobie/css/tweak.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/doobie/" class="brand"><div class="brand-wrapper"><span>doobie</span></div></a></li><li><a href="/doobie/docs/01-Introduction.html" class="">Introduction</a></li><li><a href="/doobie/docs/02-Toolkit.html" class="">Toolkit</a></li><li><a href="/doobie/docs/03-Connecting.html" class="">Connecting to a Database</a></li><li><a href="/doobie/docs/04-Selecting.html" class="">Selecting Data</a></li><li><a href="/doobie/docs/05-Parameterized.html" class="">Parameterized Queries</a></li><li><a href="/doobie/docs/06-Checking.html" class="">Typechecking Queries</a></li><li><a href="/doobie/docs/07-Updating.html" class="">DDL, Inserting, and Updating</a></li><li><a href="/doobie/docs/08-Fragments.html" class="">Statement Fragments</a></li><li><a href="/doobie/docs/09-Error-Handling.html" class="">Error Handling</a></li><li><a href="/doobie/docs/10-Logging.html" class="">Logging</a></li><li><a href="/doobie/docs/11-Arrays.html" class="">SQL Arrays</a></li><li><a href="/doobie/docs/12-Custom-Mappings.html" class="">Custom Mappings</a></li><li><a href="/doobie/docs/13-Unit-Testing.html" class=" active ">Unit Testing</a></li><li><a href="/doobie/docs/14-Managing-Connections.html" class="">Managing Connections</a></li><li><a href="/doobie/docs/15-Extensions-PostgreSQL.html" class="">Extensions for PostgreSQL</a></li><li><a href="/doobie/docs/16-Extensions-H2.html" class="">Extensions for H2</a></li><li><a href="/doobie/docs/17-FAQ.html" class="">Frequently-Asked Questions</a></li><li><a href="/doobie/" class=""></a></li><li><a href="/doobie/css/palette.css" class=""></a></li><li><a href="/doobie/css/style.css" class=""></a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/tpolecat/doobie"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/tpolecat/doobie"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('doobie A principled JDBC layer for Scala.');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('doobie A principled JDBC layer for Scala.');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="tpolecat" data-github-repo="doobie"><div class="content-wrapper"><section><h2 id="unit-testing">Unit Testing</h2>

<p>The YOLO-mode query checking feature demonstated in an earlier chapter is also available as a trait you can mix into your <a href="http://etorreborre.github.io/specs2/">Specs2</a> or <a href="http://www.scalatest.org/">ScalaTest</a> unit tests.</p>

<h3 id="setting-up">Setting Up</h3>

<p>As with earlier chapters we set up a <code class="highlighter-rouge">Transactor</code> and YOLO mode. We will also use the <code class="highlighter-rouge">doobie-specs2</code> and <code class="highlighter-rouge">doobie-scalatest</code> add-ons.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie._</span>
<span class="k">import</span> <span class="nn">doobie.implicits._</span>
<span class="k">import</span> <span class="nn">cats._</span>
<span class="k">import</span> <span class="nn">cats.data._</span>
<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>

<span class="k">val</span> <span class="n">xa</span> <span class="k">=</span> <span class="nc">Transactor</span><span class="o">.</span><span class="n">fromDriverManager</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span>
  <span class="s">"org.postgresql.Driver"</span><span class="o">,</span> <span class="s">"jdbc:postgresql:world"</span><span class="o">,</span> <span class="s">"postgres"</span><span class="o">,</span> <span class="s">""</span>
<span class="o">)</span>
</code></pre>
</div>

<p>And again we are playing with the <code class="highlighter-rouge">country</code> table, given here for reference.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">country</span> <span class="p">(</span>
  <span class="n">code</span>        <span class="n">character</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">name</span>        <span class="n">text</span>          <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">population</span>  <span class="n">integer</span>       <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">gnp</span>         <span class="n">numeric</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
  <span class="n">indepyear</span>   <span class="n">smallint</span>
  <span class="c1">-- more columns, but we won't use them here</span>
<span class="p">)</span>
</code></pre>
</div>

<p>So here are a few queries we would like to check. Note that we can only check values of type <code class="highlighter-rouge">Query0</code> and <code class="highlighter-rouge">Update0</code>; we can’t check <code class="highlighter-rouge">Process</code> or <code class="highlighter-rouge">ConnectionIO</code> values, so a good practice is to define your queries in a DAO module and apply further operations at a higher level.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Country</span><span class="o">(</span><span class="n">code</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">pop</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">gnp</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span>

<span class="k">val</span> <span class="n">trivial</span> <span class="k">=</span>
  <span class="n">sql</span><span class="s">"""
    select 42, 'foo'::varchar
  """</span><span class="o">.</span><span class="n">query</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)]</span>

<span class="k">def</span> <span class="n">biggerThan</span><span class="o">(</span><span class="n">minPop</span><span class="k">:</span> <span class="kt">Short</span><span class="o">)</span> <span class="k">=</span>
  <span class="n">sql</span><span class="s">"""
    select code, name, population, gnp, indepyear
    from country
    where population &gt; $minPop
  """</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">Country</span><span class="o">]</span>

<span class="k">def</span> <span class="n">update</span><span class="o">(</span><span class="n">oldName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">newName</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
  <span class="n">sql</span><span class="s">"""
    update country set name = $newName where name = $oldName
  """</span><span class="o">.</span><span class="n">update</span>
</code></pre>
</div>

<h3 id="the-specs2-package">The Specs2 Package</h3>

<p>The <code class="highlighter-rouge">doobie-specs2</code> add-on provides a mix-in trait that we can add to a <code class="highlighter-rouge">Specification</code> to allow for typechecking of queries, interpreted as a set of specifications.</p>

<p>Our unit test needs to extend <code class="highlighter-rouge">AnalysisSpec</code> and must define a <code class="highlighter-rouge">Transactor[IO]</code>. To construct a testcase for a query, pass it to the <code class="highlighter-rouge">check</code> method. Note that query arguments are never used, so they can be any values that typecheck.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie.specs2._</span>
<span class="k">import</span> <span class="nn">org.specs2.mutable.Specification</span>

<span class="k">object</span> <span class="nc">AnalysisTestSpec</span> <span class="k">extends</span> <span class="nc">Specification</span> <span class="k">with</span> <span class="nc">IOChecker</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">transactor</span> <span class="k">=</span> <span class="nc">Transactor</span><span class="o">.</span><span class="n">fromDriverManager</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span>
    <span class="s">"org.postgresql.Driver"</span><span class="o">,</span> <span class="s">"jdbc:postgresql:world"</span><span class="o">,</span> <span class="s">"postgres"</span><span class="o">,</span> <span class="s">""</span>
  <span class="o">)</span>

  <span class="n">check</span><span class="o">(</span><span class="n">trivial</span><span class="o">)</span>
  <span class="n">check</span><span class="o">(</span><span class="n">biggerThan</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>
  <span class="n">check</span><span class="o">(</span><span class="n">update</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">""</span><span class="o">))</span>

<span class="o">}</span>
</code></pre>
</div>

<p>When we run the test we get output similar to what we saw in the previous chapter on checking queries, but each item is now a test. Note that doing this in the REPL is a little awkward; in real source you would get the source file and line number associated with each query.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scala&gt; { _root_.specs2.run(AnalysisTestSpec); () } // pretend this is sbt&gt; test
[info] $line14.$read$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$AnalysisTestSpec$
[info] 
[info] + Query0[(Int, String)] defined at &lt;console&gt;:30
[info]   
[info]     select 42, 'foo'::varchar
[info]   
[info]   + SQL Compiles and TypeChecks
[info]   + C01 ?column? INTEGER (int4)    NULL?  →  Int
[info]   + C02 varchar  VARCHAR (varchar) NULL?  →  String
[info] + Query0[Country] defined at &lt;console&gt;:32
[info]   
[info]     select code, name, population, gnp, indepyear
[info]     from country
[info]     where population &gt; ?
[info]   
[info]   + SQL Compiles and TypeChecks
[error]   x P01 Short  →  INTEGER (int4)
[error]    Short is not coercible to INTEGER (int4) according to the JDBC
   specification. Fix this by changing the schema type to SMALLINT, or
   the Scala type to Int or JdbcType. (analysisspec.scala:72)
[info] 
[error]   x C01 code       CHAR     (bpchar)  NOT NULL  →  Int
[error]    CHAR (bpchar) is ostensibly coercible to Int according to the JDBC
   specification but is not a recommended target type. Fix this by
   changing the schema type to INTEGER; or the Scala type to Code or
   PersonId or String. (analysisspec.scala:72)
[info] 
[info]   + C02 name       VARCHAR  (varchar) NOT NULL  →  String
[info]   + C03 population INTEGER  (int4)    NOT NULL  →  Int
[error]   x C04 gnp        NUMERIC  (numeric) NULL      →  Double
[error]    NUMERIC (numeric) is ostensibly coercible to Double according to the
   JDBC specification but is not a recommended target type. Fix this by
   changing the schema type to FLOAT or DOUBLE; or the Scala type to
   BigDecimal or BigDecimal.
   Reading a NULL value into Double will result in a runtime failure. Fix
   this by making the schema type NOT NULL or by changing the Scala type
   to Option[Double] (analysisspec.scala:72)
[info] 
[error]   x C05 indepyear  SMALLINT (int2)    NULL      →  
[error]    Column is unused. Remove it from the SELECT statement. (analysisspec.scala:72)
[info] 
[info] + Update0 defined at &lt;console&gt;:30
[info]   
[info]     update country set name = ? where name = ?
[info]   
[info]   + SQL Compiles and TypeChecks
[info]   + P01 String  →  VARCHAR (varchar)
[info]   + P02 String  →  VARCHAR (text)
[info] 
[info] 
[info] Total for specification $line14.$read$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$AnalysisTestSpec$
[info] Finished in 609 ms
16 examples, 4 failures, 0 error
[info] 
</code></pre>
</div>

<h3 id="the-scalatest-package">The ScalaTest Package</h3>

<p>The <code class="highlighter-rouge">doobie-scalatest</code> add-on provides a mix-in trait that we can add to any <code class="highlighter-rouge">Assertions</code> implementation (like <code class="highlighter-rouge">FunSuite</code>) much like the Specs2 package above.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie.scalatest.imports._</span>
<span class="k">import</span> <span class="nn">org.scalatest._</span>

<span class="k">class</span> <span class="nc">AnalysisTestScalaCheck</span> <span class="k">extends</span> <span class="nc">FunSuite</span> <span class="k">with</span> <span class="nc">Matchers</span> <span class="k">with</span> <span class="nc">IOChecker</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">transactor</span> <span class="k">=</span> <span class="nc">Transactor</span><span class="o">.</span><span class="n">fromDriverManager</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span>
    <span class="s">"org.postgresql.Driver"</span><span class="o">,</span> <span class="s">"jdbc:postgresql:world"</span><span class="o">,</span> <span class="s">"postgres"</span><span class="o">,</span> <span class="s">""</span>
  <span class="o">)</span>

  <span class="n">test</span><span class="o">(</span><span class="s">"trivial"</span><span class="o">)</span>    <span class="o">{</span> <span class="n">check</span><span class="o">(</span><span class="n">trivial</span><span class="o">)</span>        <span class="o">}</span>
  <span class="n">test</span><span class="o">(</span><span class="s">"biggerThan"</span><span class="o">)</span> <span class="o">{</span> <span class="n">check</span><span class="o">(</span><span class="n">biggerThan</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>  <span class="o">}</span>
  <span class="n">test</span><span class="o">(</span><span class="s">"update"</span><span class="o">)</span>     <span class="o">{</span> <span class="n">check</span><span class="o">(</span><span class="n">update</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">""</span><span class="o">))</span> <span class="o">}</span>

<span class="o">}</span>
</code></pre>
</div>

<p>Details are shown for failing tests.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>scala&gt; (new AnalysisTestScalaCheck).execute() // pretend this is sbt&gt; test
AnalysisTestScalaCheck:
- trivial
- biggerThan *** FAILED ***
  Query0[Country] defined at &lt;console&gt;:32
    select code, name, population, gnp, indepyear
    from country
    where population &gt; ?
    ✓ SQL Compiles and TypeChecks
    ✕ P01 Short  →  INTEGER (int4)
      Short is not coercible to INTEGER (int4) according to the JDBC
      specification. Fix this by changing the schema type to SMALLINT,
      or the Scala type to Int or JdbcType.
    ✕ C01 code       CHAR     (bpchar)  NOT NULL  →  Int
      CHAR (bpchar) is ostensibly coercible to Int according to the JDBC
      specification but is not a recommended target type. Fix this by
      changing the schema type to INTEGER; or the Scala type to Code or
      PersonId or String.
    ✓ C02 name       VARCHAR  (varchar) NOT NULL  →  String
    ✓ C03 population INTEGER  (int4)    NOT NULL  →  Int
    ✕ C04 gnp        NUMERIC  (numeric) NULL      →  Double
      NUMERIC (numeric) is ostensibly coercible to Double according to
      the JDBC specification but is not a recommended target type. Fix
      this by changing the schema type to FLOAT or DOUBLE; or the Scala
      type to BigDecimal or BigDecimal.
      Reading a NULL value into Double will result in a runtime failure.
      Fix this by making the schema type NOT NULL or by changing the
      Scala type to Option[Double]
    ✕ C05 indepyear  SMALLINT (int2)    NULL      →  
      Column is unused. Remove it from the SELECT statement. (Checker.scala:65)
- update
</code></pre>
</div>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/doobie/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/doobie/js/main.js"></script></body></html>