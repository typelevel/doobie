<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Selecting Data · doobie</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='docs'/>
<link rel="canonical" href="https://github.com/typelevel/doobiedocs/04-Selecting.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>doobie
</a>
<div class="version-number">
1.0.0-RC7
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../infographic.html" class="page">Infographic</a></li>
  <li><a href="../migration.html" class="page">Migration Notes</a></li>
  <li><a href="../docs/index.html" class="page">Book of Doobie</a>
  <ul>
    <li><a href="../docs/01-Introduction.html" class="page">Introduction</a></li>
    <li><a href="../docs/02-Toolkit.html" class="page">Toolkit</a></li>
    <li><a href="../docs/03-Connecting.html" class="page">Connecting to a Database</a></li>
    <li><a href="../docs/04-Selecting.html" class="active page">Selecting Data</a></li>
    <li><a href="../docs/05-Parameterized.html" class="page">Parameterized Queries</a></li>
    <li><a href="../docs/06-Checking.html" class="page">Typechecking Queries</a></li>
    <li><a href="../docs/07-Updating.html" class="page">DDL, Inserting, and Updating</a></li>
    <li><a href="../docs/08-Fragments.html" class="page">Statement Fragments</a></li>
    <li><a href="../docs/09-Error-Handling.html" class="page">Error Handling</a></li>
    <li><a href="../docs/10-Logging.html" class="page">Logging</a></li>
    <li><a href="../docs/11-Arrays.html" class="page">SQL Arrays</a></li>
    <li><a href="../docs/12-Custom-Mappings.html" class="page">Custom Mappings</a></li>
    <li><a href="../docs/13-Unit-Testing.html" class="page">Unit Testing</a></li>
    <li><a href="../docs/14-Managing-Connections.html" class="page">Managing Connections</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html" class="page">Extensions for PostgreSQL</a></li>
    <li><a href="../docs/16-Extensions-H2.html" class="page">Extensions for H2</a></li>
    <li><a href="../docs/17-FAQ.html" class="page">Frequently-Asked Questions</a></li>
    <li><a href="../docs/18-Related-Projects.html" class="page">Related Projects</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">doobie</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>doobie
</a>
<div class="version-number">
1.0.0-RC7
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../infographic.html" class="page">Infographic</a></li>
  <li><a href="../migration.html" class="page">Migration Notes</a></li>
  <li><a href="../docs/index.html" class="page">Book of Doobie</a>
  <ul>
    <li><a href="../docs/01-Introduction.html" class="page">Introduction</a></li>
    <li><a href="../docs/02-Toolkit.html" class="page">Toolkit</a></li>
    <li><a href="../docs/03-Connecting.html" class="page">Connecting to a Database</a></li>
    <li><a href="../docs/04-Selecting.html" class="active page">Selecting Data</a></li>
    <li><a href="../docs/05-Parameterized.html" class="page">Parameterized Queries</a></li>
    <li><a href="../docs/06-Checking.html" class="page">Typechecking Queries</a></li>
    <li><a href="../docs/07-Updating.html" class="page">DDL, Inserting, and Updating</a></li>
    <li><a href="../docs/08-Fragments.html" class="page">Statement Fragments</a></li>
    <li><a href="../docs/09-Error-Handling.html" class="page">Error Handling</a></li>
    <li><a href="../docs/10-Logging.html" class="page">Logging</a></li>
    <li><a href="../docs/11-Arrays.html" class="page">SQL Arrays</a></li>
    <li><a href="../docs/12-Custom-Mappings.html" class="page">Custom Mappings</a></li>
    <li><a href="../docs/13-Unit-Testing.html" class="page">Unit Testing</a></li>
    <li><a href="../docs/14-Managing-Connections.html" class="page">Managing Connections</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html" class="page">Extensions for PostgreSQL</a></li>
    <li><a href="../docs/16-Extensions-H2.html" class="page">Extensions for H2</a></li>
    <li><a href="../docs/17-FAQ.html" class="page">Frequently-Asked Questions</a></li>
    <li><a href="../docs/18-Related-Projects.html" class="page">Related Projects</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">doobie</a></li>
  <li><a href="../docs/index.html">Book of Doobie</a></li>
  <li>Selecting Data</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h2><a href="#selecting-data" name="selecting-data" class="anchor"><span class="anchor-link"></span></a>Selecting Data</h2>
<p>In this chapter we will write some some programs to read from the database, mapping rows to Scala types on the way. We also introduce YOLO mode for experimenting with <strong>doobie</strong> in the REPL.</p>
<h3><a href="#setting-up" name="setting-up" class="anchor"><span class="anchor-link"></span></a>Setting Up</h3>
<p>First let&rsquo;s get our imports out of the way and set up a <code>Transactor</code> as we did before. You can skip this step if you still have your REPL running from last chapter.</p>
<pre class="prettyprint"><code class="language-scala">import doobie._
import doobie.implicits._
import doobie.util.ExecutionContexts
import cats._
import cats.data._
import cats.effect._
import cats.implicits._
import fs2.Stream

// This is just for testing. Consider using cats.effect.IOApp instead of calling
// unsafe methods directly.
import cats.effect.unsafe.implicits.global

// A transactor that gets connections from java.sql.DriverManager and executes blocking operations
// on our synchronous EC. See the chapter on connection handling for more info.
val xa = Transactor.fromDriverManager[IO](
  driver = &quot;org.postgresql.Driver&quot;,  // JDBC driver classname
  url = &quot;jdbc:postgresql:world&quot;,     // Connect URL
  user = &quot;postgres&quot;,                 // Database user name
  password = &quot;password&quot;,             // Database password
  logHandler = None                  // Don&#39;t setup logging for now. See Logging page for how to log events in detail
)
</code></pre>
<p>We will be playing with the <code>country</code> table, shown here for reference. If you don&rsquo;t have the <code>world</code> database set up, go back to the <a href="01-Introduction.html">Introduction</a> for instructions.</p>
<pre class="prettyprint"><code class="language-sql">CREATE TABLE country (
  code       character(3)  NOT NULL,
  name       text          NOT NULL,
  population integer       NOT NULL,
  gnp        numeric(10,2)
  -- more columns, but we won&#39;t use them here
)
</code></pre>
<h3><a href="#reading-rows-into-collections" name="reading-rows-into-collections" class="anchor"><span class="anchor-link"></span></a>Reading Rows into Collections</h3>
<p>For our first query let&rsquo;s aim low and select some country names into a <code>List</code>, then print out the first few. There are several steps here so we have noted the types along the way.</p>
<pre class="prettyprint"><code class="language-scala">sql&quot;select name from country&quot;
  .query[String]    // Query0[String]
  .to[List]         // ConnectionIO[List[String]]
  .transact(xa)     // IO[List[String]]
  .unsafeRunSync()    // List[String]
  .take(5)          // List[String]
  .foreach(println) // Unit
// Afghanistan
// Netherlands
// Netherlands Antilles
// Albania
// Algeria
</code></pre>
<p>Let&rsquo;s break this down a bit.</p>
<ul>
  <li><code>sql&quot;select name from country&quot;.query[String]</code> defines a <code>Query0[String]</code>, which is a one-column query that maps each returned row to a <code>String</code>. We will get to more interesting row types soon.</li>
  <li><code>.to[List]</code> is a convenience method that accumulates rows into a <code>List</code>, in this case yielding a <code>ConnectionIO[List[String]]</code>. It works with any collection type that has a <code>CanBuildFrom</code>. Similar methods are:
    <ul>
      <li><code>.unique</code> which returns a single value, raising an exception if there is not exactly one row returned.</li>
      <li><code>.option</code> which returns an <code>Option</code>, raising an exception if there is more than one row returned.</li>
      <li><code>.nel</code> which returns an <code>NonEmptyList</code>, raising an exception if there are no rows returned.</li>
      <li>See the Scaladoc for <code>Query0</code> for more information on these and other methods.</li>
    </ul>
  </li>
  <li>The rest is familar; <code>transact(xa)</code> yields a <code>IO[List[String]]</code> which we run, giving us a normal Scala <code>List[String]</code> that we print out.</li>
</ul>
<h3><a href="#internal-streaming" name="internal-streaming" class="anchor"><span class="anchor-link"></span></a>Internal Streaming</h3>
<p>The example above is ok, but there&rsquo;s not much point reading all the results from the database when we only want the first five rows. So let&rsquo;s try a different approach.</p>
<pre class="prettyprint"><code class="language-scala">sql&quot;select name from country&quot;
  .query[String]    // Query0[String]
  .stream           // Stream[ConnectionIO, String]
  .take(5)          // Stream[ConnectionIO, String]
  .compile.toList   // ConnectionIO[List[String]]
  .transact(xa)     // IO[List[String]]
  .unsafeRunSync()    // List[String]
  .foreach(println) // Unit
// Afghanistan
// Netherlands
// Netherlands Antilles
// Albania
// Algeria
</code></pre>
<p>The difference here is that <code>stream</code> gives us an <a href="https://github.com/functional-streams-for-scala/fs2">fs2</a> <code>Stream[ConnectionIO, String]</code> that emits rows as they arrive from the database. By applying <code>take(5)</code> we instruct the stream to shut everything down (and clean everything up) after five elements have been emitted. This is much more efficient than pulling all 239 rows and then throwing most of them away.</p>
<p>Of course a server-side <code>LIMIT</code> would be an even better way to do this (for databases that support it), but in cases where you need client-side filtering or other custom postprocessing, <code>Stream</code> is a very general and powerful tool. For more information see the <a href="https://github.com/functional-streams-for-scala/fs2">fs2</a> repo, which has a good list of learning resources.</p>
<h3><a href="#yolo-mode" name="yolo-mode" class="anchor"><span class="anchor-link"></span></a>YOLO Mode</h3>
<p>The API we have seen so far is ok, but it&rsquo;s tiresome to keep saying <code>transact(xa)</code> and doing <code>foreach(println)</code> to see what the results look like. So <strong>just for REPL exploration</strong> there is a module of extra syntax provided on your <code>Transactor</code> that you can import.</p>
<pre class="prettyprint"><code class="language-scala">val y = xa.yolo // a stable reference is required
import y._
</code></pre>
<p>We can now run our previous query in an abbreviated form.</p>
<pre class="prettyprint"><code class="language-scala">sql&quot;select name from country&quot;
  .query[String] // Query0[String]
  .stream        // Stream[ConnectionIO, String]
  .take(5)       // Stream[ConnectionIO, String]
  .quick         // IO[Unit]
  .unsafeRunSync()
</code></pre>
<p>This syntax allows you to quickly run a <code>Query0[A]</code> or <code>Stream[ConnectionIO, A]</code> and see the results printed to the console. This isn&rsquo;t a huge deal but it can save you some keystrokes when you&rsquo;re just messing around.</p>
<ul>
  <li>The <code>.quick</code> method sinks the stream to standard out (adding ANSI coloring for fun) and then calls <code>.transact</code>, yielding a <code>IO[Unit]</code>.</li>
  <li>The <code>.check</code> method returns a <code>IO[Unit]</code> that performs a metadata analysis on the provided query and asserted types and prints out a report. This is covered in detail in the chapter on typechecking queries.</li>
</ul>
<h3><a href="#multi-column-queries" name="multi-column-queries" class="anchor"><span class="anchor-link"></span></a>Multi-Column Queries</h3>
<p>We can select multiple columns, of course, and map them to a tuple. The <code>gnp</code> column in our table is nullable so we&rsquo;ll select that one into an <code>Option[Double]</code>. In a later chapter we&rsquo;ll see how to check the types to be sure they&rsquo;re sensible.</p>
<pre class="prettyprint"><code class="language-scala">sql&quot;select code, name, population, gnp from country&quot;
  .query[(String, String, Int, Option[Double])]
  .stream
  .take(5)
  .quick
  .unsafeRunSync()
</code></pre>
<p><strong>doobie</strong> supports row mappings for atomic column types, as well as options, tuples, <code>HList</code>s, shapeless records, and case classes thereof. So let&rsquo;s try the same query with an <code>HList</code>:</p>
<pre class="prettyprint"><code class="language-scala">import shapeless._

sql&quot;select code, name, population, gnp from country&quot;
  .query[String :: String :: Int :: Option[Double] :: HNil]
  .stream
  .take(5)
  .quick
  .unsafeRunSync()
</code></pre>
<p>And with a shapeless record:</p>
<pre class="prettyprint"><code class="language-scala">import shapeless.record.Record

type Rec = Record.`&#39;code -&gt; String, &#39;name -&gt; String, &#39;pop -&gt; Int, &#39;gnp -&gt; Option[Double]`.T

sql&quot;select code, name, population, gnp from country&quot;
  .query[Rec]
  .stream
  .take(5)
  .quick
  .unsafeRunSync()
</code></pre>
<p>And again, mapping rows to a case class.</p>
<pre class="prettyprint"><code class="language-scala">case class Country(code: String, name: String, pop: Int, gnp: Option[Double])
</code></pre>
<pre class="prettyprint"><code class="language-scala">sql&quot;select code, name, population, gnp from country&quot;
  .query[Country]
  .stream
  .take(5)
  .quick
  .unsafeRunSync()
</code></pre>
<p>You can also nest case classes, <code>HList</code>s, shapeless records, and/or tuples arbitrarily as long as the eventual members are of supported columns types. For instance, here we map the same set of columns to a tuple of two case classes:</p>
<pre class="prettyprint"><code class="language-scala">case class Code(code: String)
case class Country2(name: String, pop: Int, gnp: Option[Double])
</code></pre>
<pre class="prettyprint"><code class="language-scala">sql&quot;select code, name, population, gnp from country&quot;
  .query[(Code, Country2)]
  .stream
  .take(5)
  .quick
  .unsafeRunSync()
</code></pre>
<p>And just for fun, since the <code>Code</code> values are constructed from the primary key, let&rsquo;s turn the results into a <code>Map</code>. Trivial but useful.</p>
<pre class="prettyprint"><code class="language-scala">sql&quot;select code, name, population, gnp from country&quot;
  .query[(Code, Country2)]
  .stream.take(5)
  .compile.toList
  .map(_.toMap)
  .quick
  .unsafeRunSync()
</code></pre>
<h3><a href="#final-streaming" name="final-streaming" class="anchor"><span class="anchor-link"></span></a>Final Streaming</h3>
<p>In the examples above we construct a <code>Stream[ConnectionIO, A]</code> and discharge it via <code>.compile.toList</code>, yielding a <code>ConnectionIO[List[A]]</code> which eventually becomes a <code>IO[List[A]]</code>. So the construction and execution of the <code>Stream</code> is entirely internal to the <strong>doobie</strong> program.</p>
<p>However in some cases a stream is what we want as our &ldquo;top level&rdquo; type. For example, <a href="https://github.com/http4s/http4s">http4s</a> can use a <code>Stream[IO, A]</code> directly as a response type, which could allow us to stream a resultset directly to the network socket. We can achieve this in <strong>doobie</strong> by calling <code>transact</code> directly on the <code>Stream[ConnectionIO, A]</code>.</p>
<pre class="prettyprint"><code class="language-scala">val p: Stream[IO, Country2] = {
  sql&quot;select name, population, gnp from country&quot;
    .query[Country2] // Query0[Country2]
    .stream          // Stream[ConnectionIO, Country2]
    .transact(xa)    // Stream[IO, Country2]
}
// p: Stream[IO, Country2] = Stream(..)

p.take(5).compile.toVector.unsafeRunSync().foreach(println)
// Country2(Afghanistan,22720000,Some(5976.0))
// Country2(Netherlands,15864000,Some(371362.0))
// Country2(Netherlands Antilles,217000,Some(1941.0))
// Country2(Albania,3401200,Some(3205.0))
// Country2(Algeria,31471000,Some(49982.0))
</code></pre>
<h3><a href="#diving-deeper" name="diving-deeper" class="anchor"><span class="anchor-link"></span></a>Diving Deeper</h3>
<p>The <code>sql</code> interpolator is sugar for constructors defined in the <code>doobie.hi.connection</code> module, aliased as <code>HC</code> if you use the standard imports. Using these constructors directly, the above program would look like this:</p>
<pre class="prettyprint"><code class="language-scala">import doobie.hi.HC
import doobie.free.{FC, FPS}
import doobie.util.log.{LoggingInfo, Parameters}

val sql = &quot;select code, name, population, gnp from country&quot;
// sql: String = &quot;select code, name, population, gnp from country&quot;
val proc = HC.stream[(Code, Country2)](
  create = FC.prepareStatement(sql), // Create prepared statement
  prep = FPS.unit,                   // prepare steps (none)
  exec = FPS.executeQuery,           // execute the query
  chunkSize = 512,                   // chunk size
  loggingInfo = LoggingInfo(
    sql = sql,
    params = Parameters.NonBatch(List.empty), // No parameters
    label = &quot;unlabeled&quot;
  )
)
// proc: Stream[ConnectionIO, (Code, Country2)] = Stream(..)

proc.take(5)        // Stream[ConnectionIO, (Code, Country2)]
    .compile.toList // ConnectionIO[List[(Code, Country2)]]
    .map(_.toMap)   // ConnectionIO[Map[Code, Country2]]
    .quick
    .unsafeRunSync()
</code></pre>
<p>The <code>stream</code> combinator is parameterized on the element type and consumes a statement and a program in <code>PreparedStatementIO</code> that sets input parameters and any other pre-execution configuration. In this case the &ldquo;prepare&rdquo; program is a no-op.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/typelevel/doobie/tree/master/modules/docs/target/mdoc/docs/04-Selecting.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../docs/05-Parameterized.html">Parameterized Queries</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../docs/04-Selecting.html#selecting-data" class="header">Selecting Data</a>
  <ul>
    <li><a href="../docs/04-Selecting.html#setting-up" class="header">Setting Up</a></li>
    <li><a href="../docs/04-Selecting.html#reading-rows-into-collections" class="header">Reading Rows into Collections</a></li>
    <li><a href="../docs/04-Selecting.html#internal-streaming" class="header">Internal Streaming</a></li>
    <li><a href="../docs/04-Selecting.html#yolo-mode" class="header">YOLO Mode</a></li>
    <li><a href="../docs/04-Selecting.html#multi-column-queries" class="header">Multi-Column Queries</a></li>
    <li><a href="../docs/04-Selecting.html#final-streaming" class="header">Final Streaming</a></li>
    <li><a href="../docs/04-Selecting.html#diving-deeper" class="header">Diving Deeper</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2025</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.0.0-RC7', 'https://github.com/typelevel/doobie')});</script>


</html>
