<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Extensions for PostgreSQL · doobie</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='docs'/>
<link rel="canonical" href="https://github.com/typelevel/doobiedocs/15-Extensions-PostgreSQL.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>doobie
</a>
<div class="version-number">
1.0.0-RC8
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../infographic.html" class="page">Infographic</a></li>
  <li><a href="../migration.html" class="page">Migration Notes</a></li>
  <li><a href="../docs/index.html" class="page">Book of Doobie</a>
  <ul>
    <li><a href="../docs/01-Introduction.html" class="page">Introduction</a></li>
    <li><a href="../docs/02-Toolkit.html" class="page">Toolkit</a></li>
    <li><a href="../docs/03-Connecting.html" class="page">Connecting to a Database</a></li>
    <li><a href="../docs/04-Selecting.html" class="page">Selecting Data</a></li>
    <li><a href="../docs/05-Parameterized.html" class="page">Parameterized Queries</a></li>
    <li><a href="../docs/06-Checking.html" class="page">Typechecking Queries</a></li>
    <li><a href="../docs/07-Updating.html" class="page">DDL, Inserting, and Updating</a></li>
    <li><a href="../docs/08-Fragments.html" class="page">Statement Fragments</a></li>
    <li><a href="../docs/09-Error-Handling.html" class="page">Error Handling</a></li>
    <li><a href="../docs/10-Logging.html" class="page">Logging</a></li>
    <li><a href="../docs/11-Arrays.html" class="page">SQL Arrays</a></li>
    <li><a href="../docs/12-Custom-Mappings.html" class="page">Custom Mappings</a></li>
    <li><a href="../docs/19-Custom-JDBC-Operations.html" class="page">Custom JDBC Operations</a></li>
    <li><a href="../docs/13-Unit-Testing.html" class="page">Unit Testing</a></li>
    <li><a href="../docs/14-Managing-Connections.html" class="page">Managing Connections</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html" class="active page">Extensions for PostgreSQL</a></li>
    <li><a href="../docs/16-Extensions-H2.html" class="page">Extensions for H2</a></li>
    <li><a href="../docs/17-FAQ.html" class="page">Frequently-Asked Questions</a></li>
    <li><a href="../docs/18-Related-Projects.html" class="page">Related Projects</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">doobie</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>doobie
</a>
<div class="version-number">
1.0.0-RC8
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../infographic.html" class="page">Infographic</a></li>
  <li><a href="../migration.html" class="page">Migration Notes</a></li>
  <li><a href="../docs/index.html" class="page">Book of Doobie</a>
  <ul>
    <li><a href="../docs/01-Introduction.html" class="page">Introduction</a></li>
    <li><a href="../docs/02-Toolkit.html" class="page">Toolkit</a></li>
    <li><a href="../docs/03-Connecting.html" class="page">Connecting to a Database</a></li>
    <li><a href="../docs/04-Selecting.html" class="page">Selecting Data</a></li>
    <li><a href="../docs/05-Parameterized.html" class="page">Parameterized Queries</a></li>
    <li><a href="../docs/06-Checking.html" class="page">Typechecking Queries</a></li>
    <li><a href="../docs/07-Updating.html" class="page">DDL, Inserting, and Updating</a></li>
    <li><a href="../docs/08-Fragments.html" class="page">Statement Fragments</a></li>
    <li><a href="../docs/09-Error-Handling.html" class="page">Error Handling</a></li>
    <li><a href="../docs/10-Logging.html" class="page">Logging</a></li>
    <li><a href="../docs/11-Arrays.html" class="page">SQL Arrays</a></li>
    <li><a href="../docs/12-Custom-Mappings.html" class="page">Custom Mappings</a></li>
    <li><a href="../docs/19-Custom-JDBC-Operations.html" class="page">Custom JDBC Operations</a></li>
    <li><a href="../docs/13-Unit-Testing.html" class="page">Unit Testing</a></li>
    <li><a href="../docs/14-Managing-Connections.html" class="page">Managing Connections</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html" class="active page">Extensions for PostgreSQL</a></li>
    <li><a href="../docs/16-Extensions-H2.html" class="page">Extensions for H2</a></li>
    <li><a href="../docs/17-FAQ.html" class="page">Frequently-Asked Questions</a></li>
    <li><a href="../docs/18-Related-Projects.html" class="page">Related Projects</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">doobie</a></li>
  <li><a href="../docs/index.html">Book of Doobie</a></li>
  <li>Extensions for PostgreSQL</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h2><a href="#extensions-for-postgresql" name="extensions-for-postgresql" class="anchor"><span class="anchor-link"></span></a>Extensions for PostgreSQL</h2>
<p>In this chapter we discuss the extended support that <strong>doobie</strong> offers for users of <a href="http://www.postgresql.org/">PostgreSQL</a>. To use these extensions you must add an additional dependency to your project:</p>
<pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;org.tpolecat&quot; %% &quot;doobie-postgres&quot; % &quot;1.0.0-RC8&quot;
</code></pre>
<p>This library pulls in <a href="https://jdbc.postgresql.org">PostgreSQL JDBC Driver</a> as a transitive dependency.</p>
<p>There are extensions available for dealing with JSON by using Circe, if you like to use those, include this dependency:</p>
<pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;org.tpolecat&quot; %% &quot;doobie-postgres-circe&quot; % &quot;1.0.0-RC8&quot;
</code></pre>
<p>Then, you will be able to import the implicits for dealing with JSON:</p>
<pre class="prettyprint"><code class="language-scala">import doobie.postgres.circe.json.implicits._
import doobie.postgres.circe.jsonb.implicits._

</code></pre>
<h3><a href="#setting-up" name="setting-up" class="anchor"><span class="anchor-link"></span></a>Setting Up</h3>
<p>The following examples require a few imports.</p>
<pre class="prettyprint"><code class="language-scala">import cats._
import cats.data._
import cats.effect._
import cats.implicits._
import doobie._
import doobie.implicits._
import doobie.util.ExecutionContexts

// This is just for testing. Consider using cats.effect.IOApp instead of calling
// unsafe methods directly.
import cats.effect.unsafe.implicits.global

// A transactor that gets connections from java.sql.DriverManager and executes blocking operations
// on an our synchronous EC. See the chapter on connection handling for more info.
val xa = Transactor.fromDriverManager[IO](
  driver = &quot;org.postgresql.Driver&quot;,  // JDBC driver classname
  url = &quot;jdbc:postgresql:world&quot;,     // Connect URL - Driver specific
  user = &quot;postgres&quot;,                 // Database user name
  password = &quot;password&quot;,             // Database password
  logHandler = None                  // Don&#39;t setup logging for now. See Logging page for how to log events in detail
)
</code></pre>
<p><strong>doobie</strong> adds support for a large number of extended types that are not supported directly by JDBC. All mappings (except postgis) are provided in the <code>pgtypes</code> module.</p>
<pre class="prettyprint"><code class="language-scala">import doobie.postgres._
import doobie.postgres.implicits._
</code></pre>
<h3><a href="#java-8-time-types-jsr310-" name="java-8-time-types-jsr310-" class="anchor"><span class="anchor-link"></span></a>Java 8 Time Types (JSR310)</h3>
<p>To ensure <strong>doobie</strong> performs the conversion correctly between Java 8 time types and PostgreSQL Date/Time types when handling timezones or the lack thereof. The correct combination of date/time types should be used:</p>
<ul>
  <li><code>TIMESTAMP</code> maps to <code>java.time.LocalDateTime</code></li>
  <li><code>TIMESTAMPTZ</code> maps to <code>java.time.Instant</code> or <code>java.time.OffsetDateTime</code></li>
  <li><code>DATE</code> maps to <code>java.time.LocalDate</code></li>
  <li><code>TIME</code> maps to <code>java.time.LocalTime</code></li>
</ul>
<h3><a href="#array-types" name="array-types" class="anchor"><span class="anchor-link"></span></a>Array Types</h3>
<p><strong>doobie</strong> supports single-dimensional arrays of the following types:</p>
<ul>
  <li><code>bit[]</code> maps to <code>Array[Boolean]</code></li>
  <li><code>int4[]</code> map to <code>Array[Int]</code></li>
  <li><code>int8[]</code> maps to <code>Array[Long]</code></li>
  <li><code>float4[]</code> maps to <code>Array[Float]</code></li>
  <li><code>float8[]</code> maps to <code>Array[Double]</code></li>
  <li><code>varchar[]</code>, <code>char[]</code>, <code>text[],</code> and <code>bpchar[]</code> all map to <code>Array[String]</code>.</li>
  <li><code>uuid[]</code> maps to <code>Array[UUID]</code></li>
</ul>
<p>In addition to <code>Array</code> you can also map to <code>List</code> and <code>Vector</code>. Note that arrays of advanced types and structs are not supported by the driver; arrays of <code>Byte</code> are represented as <code>bytea</code>; and arrays of <code>int2</code> are incorrectly mapped by the driver as <code>Array[Int]</code> rather than <code>Array[Short]</code> and are not supported in <strong>doobie</strong>.</p>
<p>See the previous chapter on <strong>SQL Arrays</strong> for usage examples.</p>
<h3><a href="#enum-types" name="enum-types" class="anchor"><span class="anchor-link"></span></a>Enum Types</h3>
<p><strong>doobie</strong> supports mapping PostgreSQL <code>enum</code> types to Scala enumerated types, with the slight complication that Scala doesn&rsquo;t really support enumerated types as a first-class notion. We will examine three ways to construct mappings for the following PostgreSQL type:</p>
<pre class="prettyprint"><code class="language-sql">create type myenum as enum (&#39;foo&#39;, &#39;bar&#39;)
</code></pre>
<p>The first option is to map <code>myenum</code> to an instance of the execrable <code>scala.Enumeration</code> class via the <code>pgEnum</code> constructor.</p>
<pre class="prettyprint"><code class="language-scala">object MyEnum extends Enumeration {
  val foo, bar = Value
}

implicit val MyEnumMeta: Meta[MyEnum.Value] = pgEnum(MyEnum, &quot;myenum&quot;)
</code></pre>
<pre class="prettyprint"><code class="language-scala">sql&quot;select &#39;foo&#39;::myenum&quot;.query[MyEnum.Value].unique.transact(xa).unsafeRunSync()
// res0: MyEnum.Value = foo
</code></pre>
<p>It works, but <code>Enumeration</code> is terrible so it&rsquo;s unlikely you will want to do this. A better option, perhaps surprisingly, is to map <code>myenum</code> to a <strong>Java</strong> <code>enum</code> via the <code>pgJavaEnum</code> constructor.</p>
<pre class="prettyprint"><code class="language-java">// This is Java code
public enum MyJavaEnum { foo, bar; }
</code></pre>
<pre class="prettyprint"><code class="language-scala">implicit val MyJavaEnumMeta = pgJavaEnum[MyJavaEnum](&quot;myenum&quot;)
</code></pre>
<p>And the final, most general construction simply requires evidence that your target type can be translated to and from <code>String</code>.</p>
<pre class="prettyprint"><code class="language-scala">sealed trait FooBar

object FooBar {

  case object Foo extends FooBar
  case object Bar extends FooBar

  def toEnum(e: FooBar): String =
    e match {
      case Foo =&gt; &quot;foo&quot;
      case Bar =&gt; &quot;bar&quot;
    }

  def fromEnum(s: String): Option[FooBar] =
    Option(s) collect {
      case &quot;foo&quot; =&gt; Foo
      case &quot;bar&quot; =&gt; Bar
    }

}

implicit val FoobarMeta: Meta[FooBar] =
  pgEnumStringOpt(&quot;myenum&quot;, FooBar.fromEnum, FooBar.toEnum)
</code></pre>
<pre class="prettyprint"><code class="language-scala">sql&quot;select &#39;foo&#39;::myenum&quot;.query[FooBar].unique.transact(xa).unsafeRunSync()
// res1: FooBar = Foo
</code></pre>
<h3><a href="#geometric-types" name="geometric-types" class="anchor"><span class="anchor-link"></span></a>Geometric Types</h3>
<p>The following geometric types are supported, and map to driver-supplied types.</p>
<ul>
  <li>the <code>box</code> schema type maps to <code>org.postgresql.geometric.PGbox</code></li>
  <li>the <code>circle</code> schema type maps to <code>org.postgresql.geometric.PGcircle</code></li>
  <li>the <code>lseg</code> schema type maps to <code>org.postgresql.geometric.PGlseg</code></li>
  <li>the <code>path</code> schema type maps to <code>org.postgresql.geometric.PGpath</code></li>
  <li>the <code>point</code> schema type maps to <code>org.postgresql.geometric.PGpoint</code></li>
  <li>the <code>polygon</code> schema type maps to <code>org.postgresql.geometric.PGpolygon</code></li>
</ul>
<p>It is expected that these will be mapped to application-specific types via <code>xmap</code> as described in <strong>Custom Mappings</strong>.</p>
<h3><a href="#postgis-types" name="postgis-types" class="anchor"><span class="anchor-link"></span></a>PostGIS Types</h3>
<p><strong>doobie</strong> provides mappings for the top-level PostGIS geometric types provided by the <code>net.postgis</code> driver extension.</p>
<p>Mappings for postgis are provided in the <code>pgistypes</code> module. Doobie expects postgis dependency to be provided, so if you use this module you should add postgis as a dependency.</p>
<pre class="prettyprint"><code class="language-scala">libraryDependencies += &quot;net.postgis&quot; % &quot;postgis-jdbc&quot; % &quot;2.3.0&quot;
</code></pre>
<pre class="prettyprint"><code class="language-scala">// Not provided via doobie.postgres.imports._; you must import them explicitly.
import doobie.postgres.pgisimplicits._
</code></pre>
<ul>
  <li><code>PGgeometry</code></li>
  <li><code>PGbox2d</code></li>
  <li><code>PGbox3d</code></li>
</ul>
<p>In addition to the general types above, <strong>doobie</strong> provides mappings for the following abstract and concrete fine-grained types carried by <code>PGgeometry</code>:</p>
<ul>
  <li><code>Geometry</code></li>
  <li><code>ComposedGeom</code></li>
  <li><code>GeometryCollection</code></li>
  <li><code>MultiLineString</code></li>
  <li><code>MultiPolygon</code></li>
  <li><code>PointComposedGeom</code></li>
  <li><code>LineString</code></li>
  <li><code>MultiPoint</code></li>
  <li><code>Polygon</code></li>
  <li><code>Point</code></li>
</ul>
<p><a href="http://postgis.net/workshops/postgis-intro/geography.html">Geographic types</a> mappings are defined in a different object (<code>pgisgeographyimplicits</code>), to allow geometric types using geodetic coordinates.</p>
<pre class="prettyprint"><code class="language-scala">import doobie.postgres.pgisgeographyimplicits._

// or define the implicit conversion manually

implicit val geographyPoint: Meta[Point] = doobie.postgres.pgisgeographyimplicits.PointType
</code></pre>
<ul>
  <li>Point</li>
  <li>Polygon</li>
  <li>MultiPoint</li>
  <li>LineString</li>
  <li>PointComposedGeom</li>
  <li>MultiPolygon</li>
  <li>MultiLineString</li>
</ul>
<h3><a href="#range-types" name="range-types" class="anchor"><span class="anchor-link"></span></a>Range types</h3>
<p>The following range types are supported, and map to <strong>doobie</strong> generic <code>Range[T]</code> class:</p>
<ul>
  <li>the <code>int4range</code> schema type maps to <code>Range[Int]</code></li>
  <li>the <code>int8range</code> schema type maps to <code>Range[Long]</code></li>
  <li>the <code>numrange</code> schema type maps to <code>Range[BigDecimal]</code></li>
  <li>the <code>daterange</code> schema type maps to <code>Range[java.time.LocalDate]</code></li>
  <li>the <code>tsrange</code> schema type maps to <code>Range[java.time.LocalDateTime]</code></li>
  <li>the <code>tstzrange</code> schema type maps to <code>Range[java.time.OffsetDateTime]</code></li>
</ul>
<p>Non empty range maps to:</p>
<pre class="prettyprint"><code class="language-scala">case class NonEmptyRange[T](lowerBound: Option[T], upperBound: Option[T], edge: Edge) extends Range[T]
</code></pre>
<p>Empty range maps to:</p>
<pre class="prettyprint"><code class="language-scala">case object EmptyRange extends Range[Nothing]
</code></pre>
<p>To control the inclusive and exclusive bounds according to the <a href="https://www.postgresql.org/docs/current/rangetypes.html#RANGETYPES-INCLUSIVITY">PostgreSQL</a> specification you need to use a special <code>Edge</code> enumeration when creating a <code>Range</code>:</p>
<pre class="prettyprint"><code class="language-scala">object Edge {
  case object ExclExcl extends Edge
  case object ExclIncl extends Edge
  case object InclExcl extends Edge
  case object InclIncl extends Edge
}
</code></pre>
<blockquote>
  <h2><a href="#in-the-text-form-of-a-range-an-inclusive-lower-bound-is-represented-by-while-an-exclusive-upper-bound-is-represented-by-" name="in-the-text-form-of-a-range-an-inclusive-lower-bound-is-represented-by-while-an-exclusive-upper-bound-is-represented-by-" class="anchor"><span class="anchor-link"></span></a>In the text form of a range, an inclusive lower bound is represented by &lsquo;[&lsquo; while an exclusive lower bound is represented by &rsquo;(&lsquo;. Likewise, an inclusive upper bound is represented by &rsquo;]&rsquo;, while an exclusive upper bound is represented by &lsquo;)&rsquo;.</h2>
  <p>Note: the <a href="https://www.postgresql.org/docs/current/rangetypes.html#RANGETYPES">range types</a> mappings are defined in a different object (<code>rangeimplicits</code>). To enable it you must import them explicitly:</p>
</blockquote>
<pre class="prettyprint"><code class="language-scala">import doobie.postgres.rangeimplicits._
</code></pre>
<p>To create for example custom implementation of <code>Range[Byte]</code> you can use the public method which declared in the following package <code>doobie.postgres.rangeimplicits</code>:</p>
<pre class="prettyprint"><code class="language-scala">def rangeMeta[T](sqlRangeType: String)(encode: T =&gt; String, decode: String =&gt; T): Meta[Range[T]]
</code></pre>
<p>For a <code>Range[Byte]</code>, the meta and bounds encoder and decoder would appear as follows:</p>
<pre class="prettyprint"><code class="language-scala">import doobie.postgres.rangeimplicits._
import doobie.postgres.types.Range

implicit val byteRangeMeta: Meta[Range[Byte]] = rangeMeta[Byte](&quot;int4range&quot;)(_.toString, _.toByte)

val int4rangeWithByteBoundsQuery = sql&quot;select &#39;[-128, 127)&#39;::int4range&quot;.query[Range[Byte]]
</code></pre>
<h3><a href="#other-nonstandard-types" name="other-nonstandard-types" class="anchor"><span class="anchor-link"></span></a>Other Nonstandard Types</h3>
<ul>
  <li>The <code>uuid</code> schema type is supported and maps to <code>java.util.UUID</code>.</li>
  <li>The <code>inet</code> schema type is supported and maps to <code>java.net.InetAddress</code>.</li>
  <li>The <code>hstore</code> schema type is supported and maps to both <code>java.util.Map[String, String]</code> and Scala <code>Map[String, String]</code>.</li>
</ul>
<h3><a href="#extended-error-handling" name="extended-error-handling" class="anchor"><span class="anchor-link"></span></a>Extended Error Handling</h3>
<p>A complete table of SQLSTATE values is provided in the <code>doobie.postgres.sqlstate</code> module. Recovery combinators for each of these states (<code>onUniqueViolation</code> for example) are provided in <code>doobie.postgres.syntax</code>.</p>
<pre class="prettyprint"><code class="language-scala">val p = sql&quot;oops&quot;.query[String].unique // this won&#39;t work
</code></pre>
<p>Some of the recovery combinators demonstrated:</p>
<pre class="prettyprint"><code class="language-scala">p.attempt.transact(xa).unsafeRunSync() // attempt is provided by ApplicativeError instance
// res2: Either[Throwable, String] = Left(
//   value = org.postgresql.util.PSQLException: ERROR: syntax error at or near &quot;oops&quot;
//   Position: 1
// )

p.attemptSqlState.transact(xa).unsafeRunSync() // this catches only SQL exceptions
// res3: Either[SqlState, String] = Left(value = SqlState(value = &quot;42601&quot;))

p.attemptSomeSqlState { case SqlState(&quot;42601&quot;) =&gt; &quot;caught!&quot; } .transact(xa).unsafeRunSync() // catch it
// res4: Either[String, String] = Left(value = &quot;caught!&quot;)

p.attemptSomeSqlState { case sqlstate.class42.SYNTAX_ERROR =&gt; &quot;caught!&quot; } .transact(xa).unsafeRunSync() // same, w/constant
// res5: Either[String, String] = Left(value = &quot;caught!&quot;)

p.exceptSomeSqlState { case sqlstate.class42.SYNTAX_ERROR =&gt; &quot;caught!&quot;.pure[ConnectionIO] } .transact(xa).unsafeRunSync() // recover
// res6: String = &quot;caught!&quot;

p.onSyntaxError(&quot;caught!&quot;.pure[ConnectionIO]).transact(xa).unsafeRunSync() // using recovery combinator
// res7: String = &quot;caught!&quot;
</code></pre>
<h3><a href="#server-side-statements" name="server-side-statements" class="anchor"><span class="anchor-link"></span></a>Server-Side Statements</h3>
<p>PostgreSQL supports server-side caching of prepared statements after a certain number of executions, which can have desirable performance consequences for statements that only need to be planned once. Note that this caching happens only for <code>PreparedStatement</code> instances that are re-used within a single connection lifetime. <strong>doobie</strong> supports programmatic configuration of the prepare threshold:</p>
<ul>
  <li>For a given <code>Connection</code> you can set and query the prepare threshold with the <code>ConnectionIO</code> constructors <code>doobie.postgres.hi.connection.pgSetPrepareThreshold</code> and <code>pgGetPrepareThreshold</code>.</li>
  <li>For a specific <code>PreparedStatement</code> you can set and query the prepare threshold with the <code>PreparedStatementIO</code> constructors <code>doobie.postgres.hi.preparedstatement.pgSetPrepareThreshold</code> and <code>pgGetPrepareThreshold</code>.</li>
</ul>
<p>See the <a href="https://jdbc.postgresql.org/documentation/server-prepare">JDBC driver documentation</a> for more information.</p>
<h3><a href="#listen-and-notify" name="listen-and-notify" class="anchor"><span class="anchor-link"></span></a><code>LISTEN</code> and <code>NOTIFY</code></h3>
<p>PostgreSQL provides a simple transactional message queue that can be used to notify a connection that something interesting has happened. Such notifications can be tied to database triggers, which provides a way to notify clients that data has changed. Which is cool.</p>
<p><strong>doobie</strong> provides <code>ConnectionIO</code> constructors for SQL <code>LISTEN</code>, <code>UNLISTEN</code>, and <code>NOTIFY</code> in the <code>doobie.postgres.hi.connection</code> module. New notifications are retrieved (synchronously, sadly, that&rsquo;s all the driver provides) via <code>pgGetNotifications</code>. Note that all of the &ldquo;listening&rdquo; operations apply to the <strong>current connection</strong>, which must therefore be long-running and typically off to the side from normal transactional operations. Further note that you must <code>setAutoCommit(false)</code> on this connection or <code>commit</code> between each call in order to retrieve messages. The <code>examples</code> project includes a program that demonstrates how to present a channel as a <code>Stream[IO, PGNotification]</code>.</p>
<h3><a href="#large-objects" name="large-objects" class="anchor"><span class="anchor-link"></span></a>Large Objects</h3>
<p>PostgreSQL provides a facility for storing very large objects (up to 4TB each) in a single uniform storage, identified by unique numeric ID and accessed via fast byte-block transfer. Note that &ldquo;normal&rdquo; large object columns types such as <code>bytea</code> and <code>text</code> can store values as large as 1GB each, so the large object API is rarely used. However there are cases where the size and/or efficiency of large objects justifies the use of this API.</p>
<p><strong>doobie</strong> provides an algebra and free monads for the driver&rsquo;s <code>LargeObjectManager</code> and <code>LargeObject</code> types in the <code>doobie.postgres.free</code> package. There is also [the beginnings of] a high-level API that includes constructors for creating large objects from files and vice-versa. The <code>example</code> project contains a brief usage example.</p>
<p>Please file an issue or ask questions on the <a href="https://gitter.im/tpolecat/doobie">Gitter</a> channel if you need to use this API; it will evolve as use cases demand.</p>
<h3><a href="#copy-manager" name="copy-manager" class="anchor"><span class="anchor-link"></span></a>Copy Manager</h3>
<p>The PostgreSQL JDBC driver&rsquo;s <a href="https://jdbc.postgresql.org/documentation/publicapi/org/postgresql/copy/CopyManager.html">CopyManager</a> API provides a pass-through for the SQL <a href="http://www.postgresql.org/docs/9.3/static/sql-copy.html"><code>COPY</code></a> statement, allowing very fast data transfer via <code>java.io</code> streams. Here we construct a program that dumps a table to <code>Console.out</code> in CSV format, with quoted values.</p>
<pre class="prettyprint"><code class="language-scala">val q = &quot;&quot;&quot;
  copy country (name, code, population)
  to stdout (
    encoding &#39;utf-8&#39;,
    force_quote *,
    format csv
  )
  &quot;&quot;&quot;

val prog: ConnectionIO[Long] =
  PHC.pgGetCopyAPI(PFCM.copyOut(q, Console.out)) // return value is the row count
</code></pre>
<p>See the links above and sample code in the <code>examples/</code> project in the <strong>doobie</strong> GitHub repo for more information on this specialized API.</p>
<div class="alert alert-danger" role="alert">
Note: the following API was introduced in version 0.5.2 and is experimental. Community feedback and contributions (instances in particular) are encouraged.
</div>
<p><strong>doobie</strong> also provides a specialized API for very fast batch inserts using upates of the form <code>COPY ... FROM STDIN</code> and a <code>Text</code> typeclass that defines how data types are encoded in Postgres text format (similar to <code>Put</code>; instances must be present for all fields in the data type to be inserted).</p>
<p>First a temp table for our experiment.</p>
<pre class="prettyprint"><code class="language-scala">val create: ConnectionIO[Unit] =
  sql&quot;&quot;&quot;
    CREATE TEMPORARY TABLE food (
      name       VARCHAR,
      vegetarian BOOLEAN,
      calories   INTEGER
    )
  &quot;&quot;&quot;.update.run.void
</code></pre>
<p>And some values to insert. <code>Text</code> instances are provided for all the data types we are using here.</p>
<pre class="prettyprint"><code class="language-scala">case class Food(name: String, isVegetarian: Boolean, caloriesPerServing: Int)

val foods = List(
  Food(&quot;banana&quot;, true, 110),
  Food(&quot;cheddar cheese&quot;, true, 113),
  Food(&quot;Big Mac&quot;, false, 1120)
)
</code></pre>
<p>Our insert statement must have the form <code>COPY ... FROM STDIN</code>, and we can insert any <code>Foldable</code>.</p>
<pre class="prettyprint"><code class="language-scala">def insert[F[_]: Foldable](fa: F[Food]): ConnectionIO[Long] =
  sql&quot;COPY food (name, vegetarian, calories) FROM STDIN&quot;.copyIn(fa)
</code></pre>
<p>We can run it thus, yielding the number of affected rows.</p>
<pre class="prettyprint"><code class="language-scala">(create *&gt; insert(foods)).transact(xa).unsafeRunSync()
// res8: Long = 3L
</code></pre>
<h3><a href="#fastpath" name="fastpath" class="anchor"><span class="anchor-link"></span></a>Fastpath</h3>
<p><strong>doobie</strong> provides an algebra and free monad for constructing programs that use the <code>FastPathAPI</code> provided by the PostgreSQL JDBC driver, however this API is mostly deprecated in favor of server-side statements (see above). And in any case I can&rsquo;t find an example of how you would use it from Java so I don&rsquo;t have an example here. But if you&rsquo;re using it let me know and we can figure it out.</p>
<h3><a href="#explain-explain-analyze" name="explain-explain-analyze" class="anchor"><span class="anchor-link"></span></a>EXPLAIN/EXPLAIN ANALYZE</h3>
<p>The PostgreSQL server can provide an analysis of any query, using the <code>EXPLAIN</code> keyword. <strong>doobie</strong> can run <code>EXPLAIN</code> on any <code>Query0</code> or <code>Query</code> object, as long as <code>doobie.postgres._</code> and <code>doobie.postgres.implicits._</code> have been imported. Using an example from earlier in the book:</p>
<pre class="prettyprint"><code class="language-scala">sql&quot;select name from country&quot;
  .query[String]    // Query0[String]
  .explain
  .transact(xa)
  .unsafeRunSync()
  .foreach(println)
// Seq Scan on country  (cost=0.00..7.39 rows=239 width=11)
</code></pre>
<p>Similary, <code>explainAnalyze</code> will analyze the query <strong>and</strong> run it, comparing the query planner&rsquo;s estimates with real performance. Using the example above again:</p>
<pre class="prettyprint"><code class="language-scala">sql&quot;select name from country&quot;
  .query[String]    // Query0[String]
  .explainAnalyze
  .transact(xa)
  .unsafeRunSync()
  .foreach(println)
// Seq Scan on country  (cost=0.00..7.39 rows=239 width=11) (actual time=0.005..0.028 rows=239 loops=1)
// Planning Time: 0.184 ms
// Execution Time: 0.060 ms
</code></pre>
<p><code>explain</code> and <code>explainAnalyze</code> both return a <code>ConnectinIO[List[String]]</code> result, where each member of the list is one row of the query planner&rsquo;s output.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/typelevel/doobie/tree/master/modules/docs/target/mdoc/docs/15-Extensions-PostgreSQL.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../docs/16-Extensions-H2.html">Extensions for H2</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../docs/15-Extensions-PostgreSQL.html#extensions-for-postgresql" class="header">Extensions for PostgreSQL</a>
  <ul>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#setting-up" class="header">Setting Up</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#java-8-time-types-jsr310-" class="header">Java 8 Time Types (JSR310)</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#array-types" class="header">Array Types</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#enum-types" class="header">Enum Types</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#geometric-types" class="header">Geometric Types</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#postgis-types" class="header">PostGIS Types</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#range-types" class="header">Range types</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#other-nonstandard-types" class="header">Other Nonstandard Types</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#extended-error-handling" class="header">Extended Error Handling</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#server-side-statements" class="header">Server-Side Statements</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#listen-and-notify" class="header"><code>LISTEN</code> and <code>NOTIFY</code></a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#large-objects" class="header">Large Objects</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#copy-manager" class="header">Copy Manager</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#fastpath" class="header">Fastpath</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html#explain-explain-analyze" class="header">EXPLAIN/EXPLAIN ANALYZE</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2025</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.0.0-RC8', 'https://github.com/typelevel/doobie')});</script>


</html>
