<html><head><title>doobie</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Rob Norris" /><meta name="description" content="A principled JDBC layer for Scala." /><meta name="og:image" content="/doobie/img/poster.png" /><meta name="og:title" content="doobie" /><meta name="og:site_name" content="doobie" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="A principled JDBC layer for Scala." /><link rel="icon" type="image/png" href="/doobie/img/favicon.png" /><meta name="twitter:title" content="doobie" /><meta name="twitter:image" content="img/poster.png" /><meta name="twitter:description" content="A principled JDBC layer for Scala." /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/doobie/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/doobie/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/doobie/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/doobie/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/doobie/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/doobie/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/doobie/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/doobie/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/doobie/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/doobie/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/doobie/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/doobie/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/doobie/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/doobie/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/doobie/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/doobie/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/doobie/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/doobie/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/doobie/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/doobie/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/doobie/highlight/styles/color-brewer.css" /><link rel="stylesheet" href="/doobie/css/style.css" /><link rel="stylesheet" href="/doobie/css/palette.css" /><link rel="stylesheet" href="/doobie/css/codemirror.css" /><link rel="stylesheet" href="/doobie/css/tweak.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/doobie/" class="brand"><div class="brand-wrapper"><span>doobie</span></div></a></li><li><a href="/doobie/docs/01-Introduction.html" class="">Introduction</a></li><li><a href="/doobie/docs/02-Toolkit.html" class="">Toolkit</a></li><li><a href="/doobie/docs/03-Connecting.html" class="">Connecting to a Database</a></li><li><a href="/doobie/docs/04-Selecting.html" class="">Selecting Data</a></li><li><a href="/doobie/docs/05-Parameterized.html" class="">Parameterized Queries</a></li><li><a href="/doobie/docs/06-Checking.html" class="">Typechecking Queries</a></li><li><a href="/doobie/docs/07-Updating.html" class="">DDL, Inserting, and Updating</a></li><li><a href="/doobie/docs/08-Fragments.html" class="">Statement Fragments</a></li><li><a href="/doobie/docs/09-Error-Handling.html" class="">Error Handling</a></li><li><a href="/doobie/docs/10-Logging.html" class="">Logging</a></li><li><a href="/doobie/docs/11-Arrays.html" class="">SQL Arrays</a></li><li><a href="/doobie/docs/12-Custom-Mappings.html" class="">Custom Mappings</a></li><li><a href="/doobie/docs/13-Unit-Testing.html" class="">Unit Testing</a></li><li><a href="/doobie/docs/14-Managing-Connections.html" class="">Managing Connections</a></li><li><a href="/doobie/docs/15-Extensions-PostgreSQL.html" class=" active ">Extensions for PostgreSQL</a></li><li><a href="/doobie/docs/16-Extensions-H2.html" class="">Extensions for H2</a></li><li><a href="/doobie/docs/17-FAQ.html" class="">Frequently-Asked Questions</a></li><li><a href="/doobie/" class=""></a></li><li><a href="/doobie/css/palette.css" class=""></a></li><li><a href="/doobie/css/style.css" class=""></a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/tpolecat/doobie"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/tpolecat/doobie"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('doobie A principled JDBC layer for Scala.');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('doobie A principled JDBC layer for Scala.');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="tpolecat" data-github-repo="doobie"><div class="content-wrapper"><section><h2 id="extensions-for-postgresql">Extensions for PostgreSQL</h2>

<p>In this chapter we discuss the extended support that <strong>doobie</strong> offers for users of <a href="http://www.postgresql.org/">PostgreSQL</a>. To use these extensions you must add an additional dependency to your project:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"org.tpolecat"</span> <span class="o">%%</span> <span class="s">"doobie-postgres"</span> <span class="o">%</span> <span class="s">"0.5.0-M11"</span>
</code></pre>
</div>

<p>This library pulls in <a href="https://jdbc.postgresql.org/documentation/94/index.html">PostgreSQL JDBC Driver 9.4</a> as a transitive dependency.</p>

<h3 id="setting-up">Setting Up</h3>

<p>The following examples require a few imports.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie._</span><span class="o">,</span> <span class="n">doobie</span><span class="o">.</span><span class="n">implicits</span><span class="o">.</span><span class="k">_</span>
<span class="k">import</span> <span class="nn">cats._</span><span class="o">,</span> <span class="n">cats</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="k">_</span><span class="o">,</span> <span class="n">cats</span><span class="o">.</span><span class="n">effect</span><span class="o">.</span><span class="nc">IO</span><span class="o">,</span> <span class="n">cats</span><span class="o">.</span><span class="n">implicits</span><span class="o">.</span><span class="k">_</span>
<span class="k">val</span> <span class="n">xa</span> <span class="k">=</span> <span class="nc">Transactor</span><span class="o">.</span><span class="n">fromDriverManager</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span>
  <span class="s">"org.postgresql.Driver"</span><span class="o">,</span> <span class="s">"jdbc:postgresql:world"</span><span class="o">,</span> <span class="s">"postgres"</span><span class="o">,</span> <span class="s">""</span>
<span class="o">)</span>
<span class="k">val</span> <span class="n">y</span> <span class="k">=</span> <span class="n">xa</span><span class="o">.</span><span class="n">yolo</span><span class="o">;</span> <span class="k">import</span> <span class="nn">y._</span>
</code></pre>
</div>

<p><strong>doobie</strong> adds support for a large number of extended types that are not supported directly by JDBC. All mappings (except postgis) are provided in the <code class="highlighter-rouge">pgtypes</code> module.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">doobie.postgres._</span><span class="o">,</span> <span class="n">doobie</span><span class="o">.</span><span class="n">postgres</span><span class="o">.</span><span class="n">implicits</span><span class="o">.</span><span class="k">_</span>
</code></pre>
</div>

<h3 id="array-types">Array Types</h3>

<p><strong>doobie</strong> supports single-dimensional arrays of the following types:</p>

<ul>
  <li><code class="highlighter-rouge">bit[]</code> maps to <code class="highlighter-rouge">Array[Boolean]</code></li>
  <li><code class="highlighter-rouge">int4[]</code> map to <code class="highlighter-rouge">Array[Int]</code></li>
  <li><code class="highlighter-rouge">int8[]</code> maps to <code class="highlighter-rouge">Array[Long]</code></li>
  <li><code class="highlighter-rouge">float4[]</code> maps to <code class="highlighter-rouge">Array[Float]</code></li>
  <li><code class="highlighter-rouge">float8[]</code> maps to <code class="highlighter-rouge">Array[Double]</code></li>
  <li><code class="highlighter-rouge">varchar[]</code>, <code class="highlighter-rouge">char[]</code>, <code class="highlighter-rouge">text[],</code> and <code class="highlighter-rouge">bpchar[]</code> all map to <code class="highlighter-rouge">Array[String]</code>.</li>
</ul>

<p>In addition to <code class="highlighter-rouge">Array</code> you can also map to <code class="highlighter-rouge">List</code> and <code class="highlighter-rouge">Vector</code>. Note that arrays of advanced types and structs are not supported by the driver; arrays of <code class="highlighter-rouge">Byte</code> are represented as <code class="highlighter-rouge">bytea</code>; and arrays of <code class="highlighter-rouge">int2</code> are incorrectly mapped by the driver as <code class="highlighter-rouge">Array[Int]</code> rather than <code class="highlighter-rouge">Array[Short]</code> and are not supported in <strong>doobie</strong>.</p>

<p>See the previous chapter on <strong>SQL Arrays</strong> for usage examples.</p>

<h3 id="enum-types">Enum Types</h3>

<p><strong>doobie</strong> supports mapping PostgreSQL <code class="highlighter-rouge">enum</code> types to Scala enumerated types, with the slight complication that Scala doesn’t really support enumerated types as a first-class notion. We will examine three ways to construct mappings for the following PostgreSQL type:</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">create</span> <span class="k">type</span> <span class="n">myenum</span> <span class="k">as</span> <span class="n">enum</span> <span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">)</span>
</code></pre>
</div>

<p>The first option is to map <code class="highlighter-rouge">myenum</code> to an instance of the execrable <code class="highlighter-rouge">scala.Enumeration</code> class via the <code class="highlighter-rouge">pgEnum</code> constructor.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">object</span> <span class="nc">MyEnum</span> <span class="k">extends</span> <span class="nc">Enumeration</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">foo</span><span class="o">,</span> <span class="n">bar</span> <span class="k">=</span> <span class="nc">Value</span>
<span class="o">}</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nc">MyEnumMeta</span> <span class="k">=</span> <span class="n">pgEnum</span><span class="o">(</span><span class="nc">MyEnum</span><span class="o">,</span> <span class="s">"myenum"</span><span class="o">)</span>
</code></pre>
</div>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="n">sql</span><span class="s">"select 'foo'::myenum"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">MyEnum.Value</span><span class="o">].</span><span class="n">unique</span><span class="o">.</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
  <span class="n">foo</span>
</code></pre>
</div>

<p>It works, but <code class="highlighter-rouge">Enumeration</code> is terrible so it’s unlikely you will want to do this. A better option, perhaps surprisingly, is to map <code class="highlighter-rouge">myenum</code> to a <strong>Java</strong> <code class="highlighter-rouge">enum</code> via the <code class="highlighter-rouge">pgJavaEnum</code> constructor.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// This is Java code</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="n">MyJavaEnum</span> <span class="o">{</span> <span class="n">foo</span><span class="o">,</span> <span class="n">bar</span><span class="o">;</span> <span class="o">}</span>
</code></pre>
</div>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">implicit</span> <span class="k">val</span> <span class="nc">MyJavaEnumMeta</span> <span class="k">=</span> <span class="n">pgJavaEnum</span><span class="o">[</span><span class="kt">MyJavaEnum</span><span class="o">](</span><span class="s">"myenum"</span><span class="o">)</span>
</code></pre>
</div>

<p>And the final, most general construction simply requires evidence that your taget type can be translated to and from <code class="highlighter-rouge">String</code>.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">FooBar</span>

<span class="k">object</span> <span class="nc">FooBar</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Foo</span> <span class="k">extends</span> <span class="nc">FooBar</span>
  <span class="k">case</span> <span class="k">object</span> <span class="nc">Bar</span> <span class="k">extends</span> <span class="nc">FooBar</span>

  <span class="k">def</span> <span class="n">toEnum</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">FooBar</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
    <span class="n">e</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Foo</span> <span class="k">=&gt;</span> <span class="s">"foo"</span>
      <span class="k">case</span> <span class="nc">Bar</span> <span class="k">=&gt;</span> <span class="s">"bar"</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="n">fromEnum</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">FooBar</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Option</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="n">collect</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">"foo"</span> <span class="k">=&gt;</span> <span class="nc">Foo</span>
      <span class="k">case</span> <span class="s">"bar"</span> <span class="k">=&gt;</span> <span class="nc">Bar</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="n">unsafeFromEnum</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">FooBar</span> <span class="o">=</span>
    <span class="n">fromEnum</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="n">getOrElse</span><span class="o">(</span><span class="k">throw</span> <span class="n">doobie</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">invariant</span><span class="o">.</span><span class="nc">InvalidEnum</span><span class="o">[</span><span class="kt">FooBar</span><span class="o">](</span><span class="n">s</span><span class="o">))</span>

<span class="o">}</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nc">FoobarMeta</span><span class="k">:</span> <span class="kt">Meta</span><span class="o">[</span><span class="kt">FooBar</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">pgEnumString</span><span class="o">(</span><span class="s">"myenum"</span><span class="o">,</span> <span class="nc">FooBar</span><span class="o">.</span><span class="n">unsafeFromEnum</span><span class="o">,</span> <span class="nc">FooBar</span><span class="o">.</span><span class="n">toEnum</span><span class="o">)</span>
</code></pre>
</div>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="n">sql</span><span class="s">"select 'foo'::myenum"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">FooBar</span><span class="o">].</span><span class="n">unique</span><span class="o">.</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span>
  <span class="nc">Foo</span>
</code></pre>
</div>

<h3 id="geometric-types">Geometric Types</h3>

<p>The following geometric types are supported, and map to driver-supplied types.</p>

<ul>
  <li>the <code class="highlighter-rouge">box</code> schema type maps to <code class="highlighter-rouge">org.postgresql.geometric.PGbox</code></li>
  <li>the <code class="highlighter-rouge">circle</code> schema type maps to <code class="highlighter-rouge">org.postgresql.geometric.PGcircle</code></li>
  <li>the <code class="highlighter-rouge">lseg</code> schema type maps to <code class="highlighter-rouge">org.postgresql.geometric.PGlseg</code></li>
  <li>the <code class="highlighter-rouge">path</code> schema type maps to <code class="highlighter-rouge">org.postgresql.geometric.PGpath</code></li>
  <li>the <code class="highlighter-rouge">point</code> schema type maps to <code class="highlighter-rouge">org.postgresql.geometric.PGpoint</code></li>
  <li>the <code class="highlighter-rouge">polygon</code> schema type maps to <code class="highlighter-rouge">org.postgresql.geometric.PGpolygon</code></li>
</ul>

<p>It is expected that these will be mapped to application-specific types via <code class="highlighter-rouge">xmap</code> as described in <strong>Custom Mappings</strong>.</p>

<h3 id="postgis-types">PostGIS Types</h3>

<p><strong>doobie</strong> provides mappings for the top-level PostGIS geometric types provided by the <code class="highlighter-rouge">org.postgis</code> driver extension.</p>

<p>Mappings for postgis are provided in the <code class="highlighter-rouge">pgistypes</code> module. Doobie expects postgis dependency to be provided, so if you use this module you should add postgis as a dependency.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"org.postgis"</span> <span class="o">%</span> <span class="s">"postgis-jdbc"</span> <span class="o">%</span> <span class="s">"1.3.3"</span>
</code></pre>
</div>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="c1">// Not provided via doobie.postgres.imports._; you must import them explicitly.
</span><span class="k">import</span> <span class="nn">doobie.postgres.pgisimplicits._</span>
</code></pre>
</div>

<ul>
  <li><code class="highlighter-rouge">PGgeometry</code></li>
  <li><code class="highlighter-rouge">PGbox2d</code></li>
  <li><code class="highlighter-rouge">PGbox3d</code></li>
</ul>

<p>In addition to the general types above, <strong>doobie</strong> provides mappings for the following abstract and concrete fine-grained types carried by <code class="highlighter-rouge">PGgeometry</code>:</p>

<ul>
  <li><code class="highlighter-rouge">Geometry</code></li>
  <li><code class="highlighter-rouge">ComposedGeom</code></li>
  <li><code class="highlighter-rouge">GeometryCollection</code></li>
  <li><code class="highlighter-rouge">MultiLineString</code></li>
  <li><code class="highlighter-rouge">MultiPolygon</code></li>
  <li><code class="highlighter-rouge">PointComposedGeom</code></li>
  <li><code class="highlighter-rouge">LineString</code></li>
  <li><code class="highlighter-rouge">MultiPoint</code></li>
  <li><code class="highlighter-rouge">Polygon</code></li>
  <li><code class="highlighter-rouge">Point</code></li>
</ul>

<h3 id="other-nonstandard-types">Other Nonstandard Types</h3>

<ul>
  <li>The <code class="highlighter-rouge">uuid</code> schema type is supported and maps to <code class="highlighter-rouge">java.util.UUID</code>.</li>
  <li>The <code class="highlighter-rouge">inet</code> schema type is supported and maps to <code class="highlighter-rouge">java.net.InetAddress</code>.</li>
  <li>The <code class="highlighter-rouge">hstore</code> schema type is supported and maps to both <code class="highlighter-rouge">java.util.Map[String, String]</code> and Scala <code class="highlighter-rouge">Map[String, String]</code>.</li>
</ul>

<h3 id="extended-error-handling">Extended Error Handling</h3>

<p>A complete table of SQLSTATE values is provided in the <code class="highlighter-rouge">doobie.postgres.sqlstate</code> module. Recovery combinators for each of these states (<code class="highlighter-rouge">onUniqueViolation</code> for example) are provided in <code class="highlighter-rouge">doobie.postgres.syntax</code>.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">p</span> <span class="k">=</span> <span class="n">sql</span><span class="s">"oops"</span><span class="o">.</span><span class="n">query</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">unique</span> <span class="c1">// this won't work
</span></code></pre>
</div>

<p>Some of the recovery combinators demonstrated:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">attempt</span><span class="o">.</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span> <span class="c1">// attempt provided by Catchable instance
</span>  <span class="nc">Left</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="n">postgresql</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">PSQLException</span><span class="k">:</span> <span class="kt">ERROR:</span> <span class="kt">syntax</span> <span class="kt">error</span> <span class="kt">at</span> <span class="kt">or</span> <span class="kt">near</span> <span class="err">"</span><span class="kt">oops</span><span class="err">"</span>
  <span class="kt">Position:</span> <span class="err">1</span><span class="o">)</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">attemptSqlState</span><span class="o">.</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span> <span class="c1">// this catches only SQL exceptions
</span>  <span class="nc">Left</span><span class="o">(</span><span class="nc">SqlState</span><span class="o">(</span><span class="mi">42601</span><span class="o">))</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">attemptSomeSqlState</span> <span class="o">{</span> <span class="k">case</span> <span class="nc">SqlState</span><span class="o">(</span><span class="s">"42601"</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="s">"caught!"</span> <span class="o">}</span> <span class="o">.</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span> <span class="c1">// catch it
</span>  <span class="nc">Left</span><span class="o">(</span><span class="n">caught</span><span class="o">!)</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">attemptSomeSqlState</span> <span class="o">{</span> <span class="k">case</span> <span class="n">sqlstate</span><span class="o">.</span><span class="n">class42</span><span class="o">.</span><span class="nc">SYNTAX_ERROR</span> <span class="k">=&gt;</span> <span class="s">"caught!"</span> <span class="o">}</span> <span class="o">.</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span> <span class="c1">// same, w/constant
</span>  <span class="nc">Left</span><span class="o">(</span><span class="n">caught</span><span class="o">!)</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">exceptSomeSqlState</span> <span class="o">{</span> <span class="k">case</span> <span class="n">sqlstate</span><span class="o">.</span><span class="n">class42</span><span class="o">.</span><span class="nc">SYNTAX_ERROR</span> <span class="k">=&gt;</span> <span class="s">"caught!"</span><span class="o">.</span><span class="n">pure</span><span class="o">[</span><span class="kt">ConnectionIO</span><span class="o">]</span> <span class="o">}</span> <span class="o">.</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span> <span class="c1">// recover
</span>  <span class="n">caught</span><span class="o">!</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">onSyntaxError</span><span class="o">(</span><span class="s">"caught!"</span><span class="o">.</span><span class="n">pure</span><span class="o">[</span><span class="kt">ConnectionIO</span><span class="o">]).</span><span class="n">quick</span><span class="o">.</span><span class="n">unsafeRunSync</span> <span class="c1">// using recovery combinator
</span>  <span class="n">caught</span><span class="o">!</span>
</code></pre>
</div>

<h3 id="server-side-statements">Server-Side Statements</h3>

<p>PostgreSQL supports server-side caching of prepared statements after a certain number of executions, which can have desirable performance consequences for statements that only need to be planned once. Note that this caching happens only for <code class="highlighter-rouge">PreparedStatement</code> instances that are re-used within a single connection lifetime. <strong>doobie</strong> supports programmatic configuration of the prepare threshold:</p>

<ul>
  <li>For a given <code class="highlighter-rouge">Connection</code> you can set and query the prepare threshold with the <code class="highlighter-rouge">ConnectionIO</code> constructors <code class="highlighter-rouge">doobie.postgres.hi.connection.pgSetPrepareThreshold</code> and <code class="highlighter-rouge">pgGetPrepareThreshold</code>.</li>
  <li>For a specific <code class="highlighter-rouge">PreparedStatement</code> you can set and query the prepare threshold with the <code class="highlighter-rouge">PreparedStatementIO</code> constructors <code class="highlighter-rouge">doobie.postgres.hi.preparedstatement.pgSetPrepareThreshold</code> and <code class="highlighter-rouge">pgGetPrepareThreshold</code>.</li>
</ul>

<p>See the <a href="https://jdbc.postgresql.org/documentation/93/server-prepare.html">JDBC driver documentation</a> for more information.</p>

<h3 id="listen-and-notify"><code class="highlighter-rouge">LISTEN</code> and <code class="highlighter-rouge">NOTIFY</code></h3>

<p>PostgreSQL provides a simple transactional message queue that can be used to notify a connection that something interesting has happened. Such notifications can be tied to database triggers, which provides a way to notify clients that data has changed. Which is cool.</p>

<p><strong>doobie</strong> provides <code class="highlighter-rouge">ConnectionIO</code> constructors for SQL <code class="highlighter-rouge">LISTEN</code>, <code class="highlighter-rouge">UNLISTEN</code>, and <code class="highlighter-rouge">NOTIFY</code> in the <code class="highlighter-rouge">doobie.postgres.hi.connection</code> module. New notifications are retrieved (synchronously, sadly, that’s all the driver provides) via <code class="highlighter-rouge">pgGetNotifications</code>. Note that all of the “listening” operations apply to the <strong>current connection</strong>, which must therefore be long-running and typically off to the side from normal transactional operations. Further note that you must <code class="highlighter-rouge">setAutoCommit(false)</code> on this connection or <code class="highlighter-rouge">commit</code> between each call in order to retrieve messages. The <code class="highlighter-rouge">examples</code> project includes a program that demonstrates how to present a channel as a <code class="highlighter-rouge">Stream[IO, PGNotification]</code>.</p>

<h3 id="large-objects">Large Objects</h3>

<p>PostgreSQL provides a facility for storing very large objects (up to 4TB each) in a single uniform storage, identified by unique numeric ID and accessed via fast byte-block transfer. Note that “normal” large object columns types such as <code class="highlighter-rouge">bytea</code> and <code class="highlighter-rouge">text</code> can store values as large as 1GB each, so the large object API is rarely used. However there are cases where the size and/or efficiency of large objects justifies the use of this API.</p>

<p><strong>doobie</strong> provides an algebra and free monads for the driver’s <code class="highlighter-rouge">LargeObjectManager</code> and <code class="highlighter-rouge">LargeObject</code> types in the <code class="highlighter-rouge">doobie.postgres.free</code> package. There is also [the beginnings of] a high-level API that includes constructors for creating large objects from files and vice-versa. The <code class="highlighter-rouge">example</code> project contains a brief usage example.</p>

<p>Please file an issue or ask questions on the <a href="https://gitter.im/tpolecat/doobie">Gitter</a> channel if you need to use this API; it will evolve as use cases demand.</p>

<h3 id="copy-manager">Copy Manager</h3>

<p>The PostgreSQL JDBC driver’s <a href="https://jdbc.postgresql.org/documentation/publicapi/org/postgresql/copy/CopyManager.html">CopyManager</a> API provides a pass-through for the SQL <a href="http://www.postgresql.org/docs/9.3/static/sql-copy.html"><code class="highlighter-rouge">COPY</code></a> statement, allowing very fast data transfer via <code class="highlighter-rouge">java.io</code> streams. Here we construct a program that dumps a table to <code class="highlighter-rouge">Console.out</code> in CSV format, with quoted values.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">q</span> <span class="k">=</span> <span class="s">"""
  copy country (name, code, population)
  to stdout (
    encoding 'utf-8',
    force_quote *,
    format csv
  )
  """</span>

<span class="k">val</span> <span class="n">prog</span><span class="k">:</span> <span class="kt">ConnectionIO</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">PHC</span><span class="o">.</span><span class="n">pgGetCopyAPI</span><span class="o">(</span><span class="nc">PFCM</span><span class="o">.</span><span class="n">copyOut</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="nc">Console</span><span class="o">.</span><span class="n">out</span><span class="o">))</span> <span class="c1">// return value is the row count
</span></code></pre>
</div>

<p>See the links above and sample code in the <code class="highlighter-rouge">examples/</code> project in the <strong>doobie</strong> GitHub repo for more information on this specialized API.</p>

<h3 id="fastpath">Fastpath</h3>

<p><strong>doobie</strong> provides an algebra and free monad for constructing programs that use the <code class="highlighter-rouge">FastPathAPI</code> provided by the PostgreSQL JDBC driver, however this API is mostly deprecated in favor of server-side statements (see above). And in any case I can’t find an example of how you would use it from Java so I don’t have an example here. But if you’re using it let me know and we can figure it out.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/doobie/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/doobie/js/main.js"></script></body></html>